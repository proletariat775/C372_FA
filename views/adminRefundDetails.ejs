//I declare that this code was written by me. 
// I will not copy or allow others to copy my code. 
// I understand that copying code is considered as plagiarism.

// Student Name: Zoey Liaw En Yi
// Student ID:24049473
// Class: C372_002_E63C
// Date created: 06/02/2026
<%- include('partials/header', { title: 'Refund Request | Shirt Shop' }) %>
<%- include('partials/adminNavbar', { user: typeof user !== 'undefined' ? user : null }) %>

<main class="page-section">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <p class="mb-1 text-muted">Request #<%= request.id %></p>
        <h2 class="mb-0">Refund request</h2>
      </div>
      <a href="/admin/refunds" class="btn btn-outline-secondary">Back to refunds</a>
    </div>

    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success"><%= message %></div>
      <% }); %>
    <% } %>

    <% if (errors && errors.length) { %>
      <% errors.forEach(function(error) { %>
        <div class="alert alert-danger"><%= error %></div>
      <% }); %>
    <% } %>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="small text-muted">Order</div>
            <div class="fw-semibold"><%= request.orderNumber ? `Order #${request.orderNumber} (ID: ${request.orderId})` : `Order #${request.orderId}` %></div>
            <div class="small text-muted mt-2">User</div>
            <div><%= request.username %> (<%= request.email %>)</div>
          </div>
          <div class="col-md-6">
            <div class="small text-muted">Requested amount</div>
            <div class="fw-semibold">$<%= Number(request.requestedAmount || 0).toFixed(2) %></div>
            <div class="small text-muted mt-2">Approved amount</div>
            <div><%= request.approvedAmount ? '$' + Number(request.approvedAmount || 0).toFixed(2) : '-' %></div>
            <div class="small text-muted mt-2">Remaining balance</div>
            <div>$<%= Number(remaining || 0).toFixed(2) %></div>
          </div>
          <div class="col-12">
            <div class="small text-muted">Payment method</div>
            <div><%= request.paymentMethod ? request.paymentMethod.toUpperCase() : 'UNKNOWN' %></div>
          </div>
          <% if (request.reason) { %>
            <div class="col-12">
              <div class="small text-muted">Reason</div>
              <div><%= request.reason %></div>
            </div>
          <% } %>
          <% const noteStatus = (request.status || '').toUpperCase(); %>
          <% if (request.adminNote && (noteStatus === 'FAILED' || noteStatus === 'REJECTED')) { %>
            <div class="col-12">
              <div class="small text-muted">Admin note</div>
              <div><%= request.adminNote %></div>
            </div>
          <% } %>
          <div class="col-12">
            <div class="small text-muted">Status</div>
            <div><span class="badge bg-light text-dark border"><%= (request.status || 'unknown').toUpperCase() %></span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Process request</h5>
        <% if ((request.status || '').toLowerCase() !== 'pending') { %>
          <p class="text-muted mb-0">This request is already <%= request.status %>.</p>
        <% } else { %>
          <form action="/admin/refunds/<%= request.id %>/approve" method="POST" class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <label for="approve-amount" class="form-label">Refund amount (USD)</label>
              <input
                type="number"
                id="approve-amount"
                name="amount"
                class="form-control"
                min="0.01"
                max="<%= Number(remaining || 0).toFixed(2) %>"
                step="0.01"
                value="<%= Number(request.requestedAmount || 0).toFixed(2) %>"
                required
                inputmode="decimal">
                <small class="text-muted">Requested: $<%= Number(request.requestedAmount || 0).toFixed(2) %></small>
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="restock-items" name="restock">
                <label class="form-check-label" for="restock-items">Return stock to inventory</label>
              </div>
            </div>
            <div class="col-12">
              <label for="approve-note" class="form-label">Admin note (optional)</label>
              <textarea id="approve-note" name="adminNote" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-success">Approve and process</button>
            </div>
          </form>

          <form action="/admin/refunds/<%= request.id %>/reject" method="POST" class="row g-3">
            <div class="col-12">
              <label for="reject-note" class="form-label">Rejection reason</label>
              <textarea id="reject-note" name="adminNote" rows="2" class="form-control" required></textarea>
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-outline-danger">Reject request</button>
            </div>
          </form>
        <% } %>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Requested items</h5>
        <% if (!items || items.length === 0) { %>
          <p class="text-muted">No items selected for refund.</p>
        <% } else { %>
          <div class="table-responsive mb-4">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit price</th>
                  <th class="text-end">Line refund</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(function(item) { %>
                  <tr>
                    <td><%= item.productName || ('Product #' + item.productId) %></td>
                    <td class="text-center"><%= item.quantity %></td>
                    <td class="text-end">$<%= Number(item.unitPrice).toFixed(2) %></td>
                    <td class="text-end">$<%= Number(item.lineRefundAmount || (Number(item.unitPrice) * Number(item.quantity))).toFixed(2) %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>

        <h5 class="card-title">Refund transactions</h5>
        <% if (!refunds || refunds.length === 0) { %>
          <p class="text-muted mb-0">No refund transactions recorded yet.</p>
        <% } else { %>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Refund ID</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <% refunds.forEach(function(refund) { %>
                  <tr>
                    <td>#<%= refund.id %></td>
                    <td>$<%= Number(refund.amount || 0).toFixed(2) %> <%= refund.currency || '' %></td>
                    <td><span class="badge bg-light text-dark border"><%= refund.status || 'UNKNOWN' %></span></td>
                    <td><%= refund.createdAt ? new Date(refund.createdAt).toLocaleString() : '-' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<%- include('partials/footer') %>
