<%- include('partials/header', { title: 'Your Cart | Shirt Shop' }) %>
  <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>

    <section class="page-section">
      <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
          <div>
            <p class="mb-1 text-muted">Your selections</p>
            <h2 class="mb-0">Shopping cart</h2>
          </div>
        </div>

        <% if (messages && messages.length) { %>
          <% messages.forEach(function(message) { %>
            <div class="alert alert-success">
              <%= message %>
            </div>
            <% }); %>
              <% } %>

                <% if (errors && errors.length) { %>
                  <% errors.forEach(function(error) { %>
                    <div class="alert alert-danger">
                      <%= error %>
                    </div>
                    <% }); %>
                      <% } %>

                        <% if (cart.length===0) { %>
                          <div class="empty-state">
                            <h3>Your cart is empty</h3>
                            <p class="text-muted">Browse our catalogue and add items to your cart to see them here.</p>
                            <a href="/shopping" class="btn btn-primary">Start shopping</a>
                          </div>
                          <% } else { %>
                            <% let totalSavings=0; %>
                              <% cart.forEach(function(item) { %>
                                <% if (item.hasDiscount) { totalSavings +=(item.originalPrice - item.price) *
                                  item.quantity; } %>
                                  <% }); %>

                                    <div class="d-md-none">
                                      <div class="row g-4">
                                        <% cart.forEach(function(item) { %>
                                          <div class="col-12">
                                            <div class="card h-100 shadow-sm">
                                              <% if (item.image) { %>
                                                <img src="/images/<%= item.image %>" class="card-img-top"
                                                  alt="<%= item.productName %>">
                                                <% } else { %>
                                                  <div
                                                    class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                                    style="height: 180px;">
                                                    <span class="text-muted">No image available</span>
                                                  </div>
                                                  <% } %>
                                                    <div class="card-body d-flex flex-column">
                                                      <h5 class="card-title">
                                                        <%= item.productName %>
                                                      </h5>
                                                      <p class="text-muted mb-2">Size: <%= item.size || 'Standard' %>
                                                      </p>
                                                      <% if (item.hasDiscount) { %>
                                                        <p class="mb-1">
                                                          <span class="text-muted text-decoration-line-through">Price: $
                                                            <%= Number(item.originalPrice).toFixed(2) %></span><br>
                                                          <span class="text-success">Discounted: $<%=
                                                              Number(item.price).toFixed(2) %> (<%=
                                                                Number(item.discountPercentage).toFixed(2) %>%
                                                                off)</span>
                                                        </p>
                                                        <% } else { %>
                                                          <p class="mb-1">Price: $<%= Number(item.price).toFixed(2) %>
                                                          </p>
                                                          <% } %>
                                                            <p class="mb-3">Subtotal: $<%= (item.price *
                                                                item.quantity).toFixed(2) %>
                                                            </p>
                                                            <% if (item.offerMessage) { %>
                                                              <div class="alert alert-info py-2">
                                                                <span
                                                                  class="fw-semibold text-uppercase small">Offer</span>
                                                                <div class="small mb-0">
                                                                  <%= item.offerMessage %>
                                                                </div>
                                                              </div>
                                                              <% } %>
                                                                <div class="mt-auto">
                                                                  <form
                                                                    action="/cart/update/<%= item.variantId || item.productId %>"
                                                                    method="POST" class="mb-2">
                                                                    <label
                                                                      for="cart-quantity-<%= item.variantId || item.productId %>"
                                                                      class="form-label">Quantity</label>
                                                                    <div class="input-group">
                                                                      <input type="number"
                                                                        id="cart-quantity-<%= item.variantId || item.productId %>"
                                                                        name="quantity" class="form-control" min="1"
                                                                        value="<%= item.quantity %>" required>
                                                                      <button type="submit"
                                                                        class="btn btn-primary">Update</button>
                                                                    </div>
                                                                  </form>
                                                                  <form
                                                                    action="/cart/remove/<%= item.variantId || item.productId %>"
                                                                    method="POST">
                                                                    <button type="submit"
                                                                      class="btn btn-outline-danger w-100">Remove</button>
                                                                  </form>
                                                                </div>
                                                    </div>
                                            </div>
                                          </div>
                                          <% }); %>
                                      </div>
                                    </div>

                                    <div class="d-none d-md-block">
                                      <div class="table-responsive">
                                        <table class="table table-modern align-middle">
                                          <thead>
                                            <tr>
                                              <th>Item</th>
                                              <th>Size</th>
                                              <th>Price</th>
                                              <th>Qty</th>
                                              <th>Subtotal</th>
                                              <th class="text-end">Actions</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            <% cart.forEach(function(item) { %>
                                              <tr>
                                                <td>
                                                  <div class="d-flex align-items-center gap-3">
                                                    <% if (item.image) { %>
                                                      <img src="/images/<%= item.image %>" alt="<%= item.productName %>"
                                                        width="64" height="64" class="rounded">
                                                      <% } else { %>
                                                        <div
                                                          class="bg-light rounded d-flex align-items-center justify-content-center"
                                                          style="width:64px;height:64px;">
                                                          <span class="text-muted small">No image</span>
                                                        </div>
                                                        <% } %>
                                                          <div>
                                                            <div class="fw-semibold">
                                                              <%= item.productName %>
                                                            </div>
                                                            <% if (item.offerMessage) { %>
                                                              <small class="text-muted">
                                                                <%= item.offerMessage %>
                                                              </small>
                                                              <% } %>
                                                          </div>
                                                  </div>
                                                </td>
                                                <td class="text-muted">
                                                  <%= item.size || 'Standard' %>
                                                </td>
                                                <td>
                                                  <% if (item.hasDiscount) { %>
                                                    <div class="text-muted text-decoration-line-through small">$<%=
                                                        Number(item.originalPrice).toFixed(2) %>
                                                    </div>
                                                    <div class="fw-semibold text-success">$<%=
                                                        Number(item.price).toFixed(2) %>
                                                    </div>
                                                    <% } else { %>
                                                      <div class="fw-semibold">$<%= Number(item.price).toFixed(2) %>
                                                      </div>
                                                      <% } %>
                                                </td>
                                                <td style="min-width: 140px;">
                                                  <form action="/cart/update/<%= item.variantId || item.productId %>"
                                                    method="POST" class="d-flex gap-2">
                                                    <input type="number" name="quantity" class="form-control" min="1"
                                                      value="<%= item.quantity %>" required>
                                                    <button type="submit" class="btn btn-primary btn-sm">Update</button>
                                                  </form>
                                                </td>
                                                <td>$<%= (item.price * item.quantity).toFixed(2) %>
                                                </td>
                                                <td class="text-end">
                                                  <form action="/cart/remove/<%= item.variantId || item.productId %>"
                                                    method="POST">
                                                    <button type="submit"
                                                      class="btn btn-outline-danger btn-sm">Remove</button>
                                                  </form>
                                                </td>
                                              </tr>
                                              <% }); %>
                                          </tbody>
                                        </table>
                                      </div>
                                    </div>

                                    <div class="card summary-card mt-4">
                                      <div class="card-body">
                                        <div
                                          class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                                          <div>
                                            <p class="text-muted mb-1">Cart total</p>
                                            <h4 class="mb-0">$<%= Number(subtotal || 0).toFixed(2) %>
                                            </h4>
                                          </div>
                                        </div>

                                        <div class="mb-3">
                                          <label class="form-label fw-semibold">Have a coupon?</label>
                                          <form action="/cart/apply-coupon" method="POST"
                                            class="d-flex flex-column flex-sm-row gap-2">
                                            <input type="text" name="coupon" class="form-control"
                                              placeholder="Enter coupon code"
                                              value="<%= appliedCoupon ? appliedCoupon.code : '' %>">
                                            <button type="submit" class="btn btn-outline-primary">Apply</button>
                                          </form>
                                          <% if (appliedCoupon) { %>
                                            <div
                                              class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2 mt-2">
                                              <span class="text-success">Applied: <strong>
                                                  <%= appliedCoupon.code %>
                                                </strong></span>
                                              <form action="/cart/remove-coupon" method="POST">
                                                <button type="submit"
                                                  class="btn btn-outline-danger btn-sm">Remove</button>
                                              </form>
                                            </div>
                                            <% } %>
                                        </div>

                                        <div class="mb-3">
                                          <div class="d-flex justify-content-between">
                                            <span class="text-muted">Subtotal</span>
                                            <span>$<%= Number(subtotal || 0).toFixed(2) %></span>
                                          </div>
                                          <% if (discountAmount && Number(discountAmount)> 0) { %>
                                            <div class="d-flex justify-content-between text-success">
                                              <span>Coupon discount</span>
                                              <span>- $<%= Number(discountAmount).toFixed(2) %></span>
                                            </div>
                                            <% } %>
                                              <div class="d-flex justify-content-between fw-semibold mt-2">
                                                <span>Final total</span>
                                                <span>$<%= Number(finalTotal || 0).toFixed(2) %></span>
                                              </div>
                                        </div>

                                        <div class="alert alert-info py-2">
                                          Delivery preferences and fees are confirmed at checkout.
                                        </div>

                                        <div class="d-flex flex-column flex-md-row gap-2">
                                          <a href="/shopping" class="btn btn-secondary w-100 w-md-auto">Back to shop</a>
                                          <a href="/checkout" class="btn btn-success flex-grow-1">Proceed to
                                            checkout</a>
                                        </div>
                                      </div>
                                      <% if (totalSavings> 0) { %>
                                        <div class="card-footer text-success fw-semibold">
                                          You're saving $<%= totalSavings.toFixed(2) %> on this order.
                                        </div>
                                        <% } %>
                                    </div>
                                    <% } %>
      </div>
    </section>

    <%- include('partial/footer') %>