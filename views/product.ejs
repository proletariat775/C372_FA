<% const baseExtraHead = typeof extraHead !== 'undefined' ? extraHead : ''; %>
<% const pageExtraHead = `${baseExtraHead}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  .product-page {
    --pdp-bg: #f7f4ef;
    --pdp-surface: #ffffff;
    --pdp-ink: #111111;
    --pdp-muted: #6b7280;
    --pdp-accent: #c7925a;
    --pdp-line: rgba(17, 24, 39, 0.08);
    --pdp-shadow: 0 28px 60px rgba(15, 23, 42, 0.12);
    font-family: "Manrope", "Poppins", "Segoe UI", sans-serif;
    color: var(--pdp-ink);
    background: radial-gradient(circle at 10% 10%, rgba(199, 146, 90, 0.12), transparent 40%),
      linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(247, 244, 239, 0.98));
    border-radius: 2rem;
    padding: 2.5rem 0;
  }

  .product-page .product-shell {
    background: var(--pdp-surface);
    border-radius: 2.2rem;
    padding: clamp(1.5rem, 2.5vw, 3rem);
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: var(--pdp-shadow);
  }

  .product-page .product-hero-grid {
    gap: clamp(1.5rem, 3vw, 3.5rem);
  }

  .product-page .product-image-grid {
    gap: 1.2rem;
  }

  .product-page .image-tile {
    border-radius: 1.35rem;
    min-height: 420px;
    background: #f4f4f4;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
  }

  .product-page .image-tile img {
    transform: scale(1.01);
    transition: transform 0.4s ease;
  }

  .product-page .image-tile:hover img {
    transform: scale(1.04);
  }

  .product-page .image-label {
    background: rgba(17, 17, 17, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 0.65rem;
  }

  .product-page .gallery-detail-block {
    margin-top: 1.75rem;
    padding: 1.5rem;
    border-radius: 1.2rem;
    background: #f8f6f3;
    border: 1px solid var(--pdp-line);
  }

  .product-page .gallery-detail-block h4 {
    font-family: "Fraunces", serif;
    font-size: 1.2rem;
    margin-bottom: 0.75rem;
  }

  .product-page .product-detail-panel {
    background: var(--pdp-surface);
    border-radius: 1.6rem;
    padding: 2rem;
    border: 1px solid var(--pdp-line);
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.1);
    position: sticky;
    top: 96px;
  }

  .product-page .product-meta {
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 0.65rem;
    color: var(--pdp-muted);
  }

  .product-page .product-title {
    font-family: "Fraunces", serif;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .product-page .price-current {
    font-size: 2rem;
    font-weight: 700;
  }

  .product-page .price-stack .text-decoration-line-through {
    font-size: 1rem;
  }

  .product-page .gst-note {
    color: var(--pdp-muted);
    letter-spacing: 0.2em;
  }

  .product-page .promo-box {
    background: rgba(199, 146, 90, 0.12);
    border: 1px solid rgba(199, 146, 90, 0.35);
    border-left: 4px solid var(--pdp-accent);
  }

  .product-page .product-option {
    padding-top: 1rem;
    border-top: 1px solid var(--pdp-line);
  }

  .product-page .product-option:first-of-type {
    border-top: none;
    padding-top: 0;
  }

  .product-page .size-choice-group {
    gap: 0.6rem;
  }

  .product-page .size-option {
    border-radius: 0.75rem;
    min-width: 52px;
    height: 40px;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: 1px solid rgba(17, 17, 17, 0.2);
  }

  .product-page .btn-check:checked + .size-option {
    background: #111111;
    border-color: #111111;
    color: #ffffff;
  }

  .product-page .action-row {
    gap: 1rem;
  }

  .product-page .action-form .form-control {
    border-radius: 0.85rem;
    border: 1px solid rgba(17, 17, 17, 0.15);
  }

  .product-page #add-to-bag-button,
  .product-page .wishlist-form .btn {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.85rem;
    border-radius: 0.85rem;
  }

  .product-page .fit-helper {
    background: linear-gradient(135deg, rgba(17, 17, 17, 0.04), rgba(199, 146, 90, 0.12));
    border: 1px solid var(--pdp-line);
  }

  .product-page .size-guide {
    background: #ffffff;
    border-radius: 1.5rem;
    padding: 2rem;
    border: 1px solid var(--pdp-line);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
  }

  .product-page .table-modern {
    border-collapse: separate;
    border-spacing: 0 0.6rem;
  }

  .product-page .table-modern thead {
    background: #f6f5f2;
  }

  .product-page .table-modern th {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--pdp-muted);
  }

  .product-page .table-modern tbody tr {
    background: #ffffff;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.05);
  }

  .product-page .table-modern tbody tr td:first-child {
    border-top-left-radius: 0.75rem;
    border-bottom-left-radius: 0.75rem;
  }

  .product-page .table-modern tbody tr td:last-child {
    border-top-right-radius: 0.75rem;
    border-bottom-right-radius: 0.75rem;
  }

  .product-page .review-section {
    background: #ffffff;
    border-radius: 1.6rem;
    padding: 2rem;
    border: 1px solid var(--pdp-line);
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
  }

  .product-page .review-item {
    background: #f9f8f6;
    border-radius: 1rem;
    padding: 1rem;
    border: 1px solid rgba(17, 17, 17, 0.06);
  }

  .product-page .related-section .card {
    border-radius: 1.4rem;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(17, 17, 17, 0.08);
  }

  .product-page .related-section .card-img-top {
    border-top-left-radius: 1.4rem;
    border-top-right-radius: 1.4rem;
  }

  .product-page .price-stack .text-muted {
    color: var(--pdp-muted) !important;
  }

  @keyframes pdpFadeUp {
    from {
      opacity: 0;
      transform: translateY(14px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .product-page .product-hero-grid,
  .product-page .size-guide,
  .product-page .review-section,
  .product-page .related-section {
    animation: pdpFadeUp 0.6s ease both;
  }

  .product-page .size-guide {
    animation-delay: 0.05s;
  }

  .product-page .review-section {
    animation-delay: 0.08s;
  }

  .product-page .related-section {
    animation-delay: 0.1s;
  }

  @media (prefers-reduced-motion: reduce) {
    .product-page .product-hero-grid,
    .product-page .size-guide,
    .product-page .review-section,
    .product-page .related-section {
      animation: none;
    }
  }

  @media (max-width: 991px) {
    .product-page .product-detail-panel {
      position: static;
      padding: 1.5rem;
    }
  }

  @media (max-width: 576px) {
    .product-page {
      padding: 1.5rem 0;
      border-radius: 1.5rem;
    }

    .product-page .product-shell {
      padding: 1.5rem;
    }

    .product-page .image-tile {
      min-height: 300px;
    }

    .product-page .product-title {
      font-size: 1.8rem;
    }
  }
</style>
`; %>
<%- include('partials/header', { title: metaTitle, extraHead: pageExtraHead }) %>
  <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>

    <section class="page-section product-page">
      <div class="container product-shell">
        <% if (messages && messages.length) { %>
          <% messages.forEach(function(message) { %>
            <div class="alert alert-success">
              <%= message %>
            </div>
            <% }); %>
              <% } %>

                <% if (errors && errors.length) { %>
                  <% errors.forEach(function(error) { %>
                    <div class="alert alert-danger">
                      <%= error %>
                    </div>
                    <% }); %>
                      <% } %>

                        <% if (product) { %>
                          <% const detail=productDetails || {}; %>
                            <% const gallery=(productImages && productImages.length) ? productImages : (product.image ?
                              [{ image_url: product.image, is_primary: 1 }] : []); %>
                              <% const sizeOrder=['3XS', '2XS' , 'XS' , 'S' , 'M' , 'L' , 'XL' , '2XL' , '3XL'
                                , 'One-Size' ]; %>
                                <% const normalizeSize=(value)=> {
                                  if (!value) return '';
                                  const cleaned = String(value).trim().toUpperCase().replace(/_/g, '-');
                                  if (cleaned === 'ONE-SIZE' || cleaned === 'ONESIZE') return 'One-Size';
                                  return cleaned;
                                  }; %>
                                  <% const variantOptions=(productVariants && productVariants.length) ? productVariants
                                    : []; %>
                                    <% const sortedVariants=variantOptions.slice().sort((a, b)=> {
                                      const aIndex = sizeOrder.indexOf(normalizeSize(a.size));
                                      const bIndex = sizeOrder.indexOf(normalizeSize(b.size));
                                      if (aIndex === -1 && bIndex === -1) return 0;
                                      if (aIndex === -1) return 1;
                                      if (bIndex === -1) return -1;
                                      return aIndex - bIndex;
                                      }); %>
                                      <% const fallbackSizes=sortedVariants.map(variant=>
                                        normalizeSize(variant.size)).filter(Boolean); %>
                                        <% const sizesToShow=Array.from(new Set(fallbackSizes)); %>
                                          <% const variantSizeList=fallbackSizes.join(', '); %>

                      <div class="product-hero-grid">
                        <div class="product-gallery">
                          <div class="product-image-grid <%= gallery.length > 1 ? ' two-up' : 'one-up' %>">
                                                <% if (gallery.length) { %>
                                                  <% gallery.slice(0, 2).forEach(function(img, index) { %>
                                                    <div class="image-tile">
                                                      <img src="/images/<%= img.image_url %>"
                                                        alt="<%= product.productName %> view <%= index + 1 %>">
                                                      <span class="image-label">
                                                        <%= index===0 ? 'Front' : 'Back' %>
                                                      </span>
                                                    </div>
                                                    <% }); %>
                                                      <% } else { %>
                                                        <div class="image-tile placeholder">
                                                          <span class="text-muted">No image available</span>
                                                        </div>
                                                        <% } %>
      </div>

      <div class="gallery-detail-block">
        <h4 class="mb-2">Product highlights</h4>
        <% if (detail.description) { %>
          <p class="text-muted mb-3">
            <%= detail.description %>
          </p>
          <% } %>
            <div class="row g-3">
              <div class="col-6">
                <div class="text-muted small">Fit type</div>
                <div class="fw-semibold">
                  <%= detail.fitType ? detail.fitType : 'Not specified' %>
                </div>
              </div>
              <div class="col-6">
                <div class="text-muted small">Material</div>
                <div class="fw-semibold">
                  <%= detail.material ? detail.material : 'Not specified' %>
                </div>
              </div>
              <div class="col-6">
                <div class="text-muted small">Color</div>
                <div class="fw-semibold">
                  <%= detail.color ? detail.color : 'Not specified' %>
                </div>
              </div>
              <div class="col-6">
                <div class="text-muted small">Care</div>
                <div class="fw-semibold">
                  <%= detail.care ? detail.care : 'Not specified' %>
                </div>
              </div>
              <div class="col-12">
                <div class="text-muted small">Available sizes</div>
                <div class="fw-semibold">
                  <%= variantSizeList || 'Not specified' %>
                </div>
              </div>
            </div>
      </div>
      </div>

      <div class="product-detail-panel">
        <div class="product-meta">
          <% if (product.brand) { %>
            <span class="product-brand">
              <%= product.brand %>
            </span>
            <% } %>
              <span class="text-muted">in <%= product.category || 'General' %></span>
        </div>
        <h1 class="product-title">
          <%= product.productName %>
        </h1>

        <div class="price-stack">
          <% if (product.hasDiscount) { %>
            <span class="price-current text-danger">$<%= Number(product.effectivePrice).toFixed(2) %></span>
            <span class="text-muted text-decoration-line-through">$<%= Number(product.price).toFixed(2) %></span>
            <% } else { %>
              <span class="price-current">$<%= Number(product.price).toFixed(2) %></span>
              <% } %>
        </div>
        <div class="gst-note">GST included</div>

        <% if (product.offerMessage) { %>
          <div class="promo-box">
            <strong>Offer</strong>
            <p class="mb-0">
              <%= product.offerMessage %>
            </p>
          </div>
          <% } %>

            <div class="product-option">
              <span class="option-label">Color</span>
              <p class="mb-0">
                <%= detail.color ? detail.color : 'Not specified' %>
              </p>
            </div>

            <% if (user && user.role==='customer' ) { %>
              <% if (product.quantity <=0) { %>
                <div class="alert alert-warning mt-3">Out of stock - we will restock soon.</div>
                <% } %>
                  <div class="action-row">
                    <form action="/add-to-cart/<%= product.id %>" method="POST" class="action-form">
                      <div class="product-option">
                        <span class="option-label">Size</span>
                        <% if (sizesToShow.length) { %>
                          <% let requiredAdded=false; %>
                            <div class="size-choice-group">
                              <% sizesToShow.forEach(function(sizeLabel) { %>
                                <% const variant=sortedVariants.find(v=> normalizeSize(v.size) ===
                                  normalizeSize(sizeLabel)); %>
                                  <% const variantId=variant ? variant.id : null; %>
                                    <% const stockQty=variant ? Number(variant.quantity || 0) : 0; %>
                                      <% const inStock=stockQty> 0; %>
                                        <% const hasVariant=Boolean(variantId); %>
                                          <input class="btn-check" type="radio" name="variantId"
                                            id="size-<%= (variantId || sizeLabel).toString().replace(/\\s+/g, '-') %>"
                                            value="<%= variantId || '' %>" data-qty="<%= stockQty %>" <%=hasVariant &&
                                            !requiredAdded ? 'required' : '' %>
                                          <%= hasVariant ? '' : 'disabled' %>>
                                            <label
                                              class="size-option <%= hasVariant ? (inStock ? '' : 'out-of-stock') : 'disabled' %>"
                                              for="size-<%= (variantId || sizeLabel).toString().replace(/\\s+/g, '-') %>">
                                              <%= sizeLabel %>
                                            </label>
                                            <% if (hasVariant && !requiredAdded) { requiredAdded=true; } %>
                                              <% }); %>
                            </div>
                            <div id="size-availability" class="text-muted small mt-2">Select a size to see
                              availability.</div>
                            <div class="option-links">
                              <a href="#size-guide" class="option-link">View size guide</a>
                              <span class="dot-sep">|</span>
                              <a href="/fit-assistant" class="option-link">Find your size</a>
                            </div>
                            <% } else { %>
                              <p class="text-muted mb-0">Sizes not specified</p>
                              <div class="option-links">
                                <a href="/fit-assistant" class="option-link">Find your size</a>
                              </div>
                              <% } %>
                      </div>
                      <label for="detail-qty" class="form-label">Quantity</label>
                      <div class="d-flex gap-2">
                        <input type="number" class="form-control" id="detail-qty" name="quantity" min="1"
                          max="<%= product.quantity %>" value="1" required>
                        <button type="submit" class="btn btn-primary flex-grow-1" id="add-to-bag-button"
                          <%=product.quantity <=0 ? 'disabled' : '' %>>Add to bag</button>
                      </div>
                    </form>
                    <form action="/wishlist/<%= product.id %>/add" method="POST" class="wishlist-form">
                      <button type="submit" class="btn btn-outline-dark w-100">Add to wish list</button>
                    </form>
                  </div>
                  <% } else { %>
                    <div class="d-flex gap-2 mt-4">
                      <a href="/updateProduct/<%= product.id %>" class="btn btn-primary">Edit product</a>
                      <a href="/inventory" class="btn btn-secondary">Back to inventory</a>
                    </div>
                    <% } %>

                      <div class="fit-helper">
                        <div class="d-flex justify-content-between align-items-center">
                          <h5 class="mb-0">Fit Assistant</h5>
                          <a href="/fit-assistant" class="small text-decoration-none">Try it</a>
                        </div>
                        <% if (typeof recommendedSize !=='undefined' && recommendedSize) { %>
                          <p class="mb-1">Recommended size: <strong>
                              <%= recommendedSize %>
                            </strong></p>
                          <p class="text-muted mb-0">Confidence: <%= typeof confidence !=='undefined' ? confidence : '-'
                              %>
                          </p>
                          <% } else { %>
                            <p class="text-muted mb-0">Get a personalised fit based on your measurements.</p>
                            <% } %>
                      </div>
      </div>
      </div>

      <div class="size-guide" id="size-guide">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
          <div>
            <h3 class="mb-1">Size guide</h3>
            <p class="text-muted mb-0">Measurements shown in cm with inches in parentheses.</p>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-modern align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">Size</th>
                <th scope="col">Chest width</th>
                <th scope="col">Shoulder</th>
                <th scope="col">Length</th>
              </tr>
            </thead>
            <tbody>
              <% (sizeChart || []).forEach(function(row) { %>
                <tr>
                  <td class="fw-semibold">
                    <%= row.size %>
                  </td>
                  <td>
                    <%= row.garmentChestWidth %> cm (<%= cmToIn(row.garmentChestWidth) %> in)
                  </td>
                  <td>
                    <%= row.garmentShoulder %> cm (<%= cmToIn(row.garmentShoulder) %> in)
                  </td>
                  <td>
                    <%= row.garmentLength %> cm (<%= cmToIn(row.garmentLength) %> in)
                  </td>
                </tr>
                <% }); %>
            </tbody>
          </table>
        </div>
        <p class="text-muted small mb-0 mt-2">
          <%= sizeGuideDisclaimer %>
        </p>
      </div>

      <div class="review-section mt-5">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-4">
          <div>
            <h3 class="mb-1">Customer reviews</h3>
            <p class="text-muted mb-0">See what other shoppers say about this style.</p>
          </div>
        </div>

        <div class="review-overview">
          <% const totalReviews=reviewSummary && reviewSummary.total ? reviewSummary.total : 0; %>
            <div class="review-score">
              <div class="review-score-value">
                <%= typeof averageRating==='number' ? averageRating.toFixed(1) : '0.0' %>
              </div>
              <div class="review-stars" aria-label="Average rating">
                <% const roundedRating=typeof averageRating==='number' ? Math.round(averageRating) : 0; %>
                  <% for (let i=1; i <=5; i++) { %>
                    <span class="star <%= i <= roundedRating ? 'filled' : '' %>">â˜…</span>
                    <% } %>
              </div>
              <p class="text-muted mb-0">Based on <%= totalReviews %> reviews</p>
            </div>

            <div class="review-summary-grid">
              <% [5,4,3,2,1].forEach(function(score) { %>
                <% const count=reviewSummary && reviewSummary.counts ? reviewSummary.counts[score] : 0; %>
                  <% const percent=totalReviews ? (count / totalReviews) * 100 : 0; %>
                    <div class="review-bar-row">
                      <span class="review-label">
                        <%= score %> star
                      </span>
                      <div class="review-bar">
                        <span style="width: <%= percent %>%;"></span>
                      </div>
                      <span class="review-count">
                        <%= count %>
                      </span>
                    </div>
                    <% }); %>
            </div>
        </div>

        <div class="mt-4">
          <% if (user && user.role==='customer' && userReview) { %>
            <div class="alert alert-light border">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Your review</strong>
                <span class="badge bg-warning text-dark">
                  <%= userReview.rating %> / 5
                </span>
              </div>
              <p class="mb-0 text-muted">
                <%= userReview.comment || 'No comments provided.' %>
              </p>
            </div>
            <% } else if (user && user.role==='customer' ) { %>
              <div class="alert alert-info">
                Submit reviews from Purchase History after your order is completed.
              </div>
              <% } else { %>
                <p class="text-muted">Sign in as a shopper to view or submit reviews.</p>
                <% } %>
        </div>

        <% if (reviews && reviews.length) { %>
          <div class="review-list">
            <% reviews.forEach(function(review) { %>
              <div class="review-item">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>
                    <%= review.username %>
                  </strong>
                  <span class="badge bg-warning text-dark">
                    <%= review.rating %> / 5
                  </span>
                </div>
                <small class="text-muted">
                  <%= new Date(review.created_at).toLocaleString() %>
                </small>
                <p class="mb-0 mt-2">
                  <%= review.comment || 'No comments provided.' %>
                </p>
              </div>
              <% }); %>
          </div>
          <% } else { %>
            <p class="text-muted mb-0">No reviews yet. Be the first to share your experience!</p>
            <% } %>
      </div>

      <% if (typeof relatedProducts !=='undefined' && relatedProducts && relatedProducts.length) { %>
        <div class="row g-4 mt-5 related-section">
          <div class="col-12">
            <h3 class="mb-3">You may also like</h3>
            <div class="row g-3">
              <% relatedProducts.slice(0, 3).forEach(function(item) { %>
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="card h-100 shadow-sm">
                    <% if (item.image) { %>
                      <img src="/images/<%= item.image %>" class="card-img-top"
                        alt="<%= item.productName || item.name %>">
                      <% } else { %>
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                          style="height: 200px;">
                          <span class="text-muted">No image available</span>
                        </div>
                        <% } %>
                          <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                              <a href="/product/<%= item.id %>" class="text-decoration-none text-dark">
                                <%= item.productName || item.name %>
                              </a>
                            </h5>
                            <p class="text-muted mb-3">Fresh picks in inclusive sizes.</p>
                            <div class="mt-auto">
                              <span class="fw-semibold">$<%= Number(item.effectivePrice || item.price || 0).toFixed(2)
                                  %></span>
                              <a href="/product/<%= item.id %>" class="btn btn-outline-primary w-100 mt-2">View
                                product</a>
                            </div>
                          </div>
                  </div>
                </div>
                <% }); %>
            </div>
          </div>
        </div>
        <% } %>

          <% } else { %>
            <div class="empty-state">
              <h3>Product not found</h3>
              <p class="text-muted">The product you are looking for is no longer available.</p>
              <a href="/shopping" class="btn btn-primary">Browse shirts</a>
            </div>
            <% } %>
              </div>
    </section>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var availability = document.getElementById('size-availability');
        var sizeRadios = document.querySelectorAll('input[name="variantId"]');
        var addButton = document.getElementById('add-to-bag-button');
        var qtyInput = document.getElementById('detail-qty');

        if (!availability || !sizeRadios.length) {
          return;
        }

        var updateAvailability = function (event) {
          var target = event && event.target ? event.target : document.querySelector('input[name="variantId"]:checked');
          if (!target) {
            availability.textContent = 'Select a size to see availability.';
