<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel='stylesheet' href='/css/styles.css'>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>
    <%= product ? product.productName : 'Shirt' %> | Shirt Shop
  </title>
  <%# meta helpers: prefer explicit product fields, fallback to site defaults %>
  <% const metaTitle = product
    ? (product.productName + ' | Shirt Shop')
    : 'Shirt Shop - Quality Shirts';
  const metaDescription = product
    ? (product.offerMessage || product.description || ('Buy ' + product.productName + ' at Shirt Shop'))
    : 'Shirt Shop - quality shirts for every occasion.';
  const metaImage = product && product.image
    ? '/images/' + product.image
    : '/images/shirt-sample-1.svg';
  const metaUrl = (typeof host !== 'undefined') ? host : ''; %>
    <meta name="description" content="<%= metaDescription %>">
    <meta property="og:title" content="<%= metaTitle %>">
    <meta property="og:description" content="<%= metaDescription %>">
    <meta property="og:image" content="<%= metaImage %>">
    <meta property="og:type" content="product">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= metaTitle %>">
    <meta name="twitter:description" content="<%= metaDescription %>">
    <meta name="twitter:image" content="<%= metaImage %>">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%= product ? product.productName : 'Shirt Shop Product' %>",
      "image": ["<%= metaImage %>"],
      "description": "<%= metaDescription %>",
      "offers": {
        "@type": "Offer",
        "priceCurrency": "USD",
        "price": "<%= product ? Number(product.effectivePrice || product.price).toFixed(2) : '0.00' %>",
        "availability": "<%= product && product.quantity>0 ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock' %>"
      }
    }
  </script>
</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Shirt Shop</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav ms-auto">
          <% if (user && user.role==='admin' ) { %>
            <li class="nav-item">
              <a class="nav-link" href="/inventory">Inventory</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/addProduct">Add Product</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/admin/users">Manage Users</a>
            </li>
            <% } else { %>
              <li class="nav-item">
                <a class="nav-link" href="/shopping">Shop</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/cart">Cart</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/orders/history">Purchase History</a>
              </li>
              <% } %>
                <li class="nav-item">
                  <a class="nav-link" href="/logout">Logout</a>
                </li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="page-section">
    <div class="container">
      <% if (messages && messages.length) { %>
        <% messages.forEach(function(message) { %>
          <div class="alert alert-success">
            <%= message %>
          </div>
          <% }); %>
            <% } %>

              <% if (errors && errors.length) { %>
                <% errors.forEach(function(error) { %>
                  <div class="alert alert-danger">
                    <%= error %>
                  </div>
                  <% }); %>
                    <% } %>

                      <% if (product) { %>
                        <div class="row g-4 align-items-start">
                          <div class="col-12 col-lg-6">
                            <div class="card shadow-sm">
                              <% if (product.image) { %>
                                <img src="/images/<%= product.image %>" class="card-img-top"
                                  alt="<%= product.productName %>">
                                <% } else { %>
                                  <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                    style="height: 260px;">
                                    <span class="text-muted">No image available</span>
                                  </div>
                                  <% } %>
                            </div>
                          </div>
                          <div class="col-12 col-lg-6">
                            <div class="card shadow-sm">
                              <div class="card-body">
                                <span class="badge bg-primary text-uppercase mb-3">
                                  <%= user.role %>
                                </span>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                  <h2 class="card-title mb-0">
                                    <%= product.productName %>
                                  </h2>
                                  <span class="badge bg-dark-subtle text-dark">
                                    <%= product.category || 'General' %>
                                  </span>
                                </div>
                                <p class="text-muted mb-4">Stock available: <strong>
                                    <%= product.quantity %>
                                  </strong></p>
                                <% if (product.hasDiscount) { %>
                                  <div class="mb-3">
                                    <div class="text-muted text-decoration-line-through">$<%=
                                        Number(product.price).toFixed(2) %>
                                    </div>
                                    <h3 class="fw-bold text-success mb-0">$<%= Number(product.effectivePrice).toFixed(2)
                                        %>
                                    </h3>
                                    <small class="text-success">You saved <strong>$<%= (Number(product.price) -
                                          Number(product.effectivePrice)).toFixed(2) %></strong> (<%=
                                        Number(product.discountPercentage).toFixed(2) %>% off)</small>
                                  </div>
                                  <% } else { %>
                                    <h3 class="fw-bold mb-4">$<%= Number(product.price).toFixed(2) %>
                                    </h3>
                                    <% } %>

                                      <% if (product.offerMessage) { %>
                                        <div class="alert alert-info py-2">
                                          <span class="fw-semibold text-uppercase small">Offer</span>
                                          <div class="mb-0">
                                            <%= product.offerMessage %>
                                          </div>
                                        </div>
                                        <% } %>

                                          <div class="border rounded-3 p-3 bg-light mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                              <h5 class="mb-0">Fit Assistant</h5>
                                              <a href="#size-guide" class="small text-decoration-none">View size guide</a>
                                            </div>
                                            <% if (typeof recommendedSize !== 'undefined' && recommendedSize) { %>
                                              <p class="mb-1">Recommended size: <strong><%= recommendedSize %></strong></p>
                                              <p class="text-muted mb-0">Confidence: <%= typeof confidence !== 'undefined' ? confidence : '-' %></p>
                                              <% } else { %>
                                                <p class="text-muted mb-2">Get a personalized size recommendation based on your measurements.</p>
                                                <a href="/fit-assistant"
                                                  class="btn btn-outline-primary btn-sm">Enter measurements for size recommendation</a>
                                                <% } %>
                                          </div>

                                          <% if (user && user.role === 'user') { %>
                                            <form action="/add-to-cart/<%= product.id %>" method="POST"
                                              class="d-flex flex-column flex-sm-row gap-3">
                                              <div class="flex-grow-1">
                                                <label for="detail-qty" class="form-label">Quantity</label>
                                                <input type="number" class="form-control" id="detail-qty"
                                                  name="quantity" min="1" max="<%= product.quantity %>" value="1"
                                                  required>
                                              </div>
                                              <div class="align-self-end">
                                                <button type="submit" class="btn btn-primary">Add to cart</button>
                                              </div>
                                            </form>
                                            <% } else { %>
                                              <div class="d-flex gap-3">
                                                <a href="/updateProduct/<%= product.id %>" class="btn btn-primary">Edit
                                                  product</a>
                                                <a href="/inventory" class="btn btn-secondary">Back to inventory</a>
                                              </div>
                                              <% } %>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row g-4 mt-4">
                          <div class="col-12 col-lg-7">
                            <div class="card shadow-sm">
                              <div class="card-body">
                                <% const detail = productDetails || {}; %>
                                <h3 class="card-title mb-3">About this shirt</h3>
                                <p class="text-muted mb-3"><%= detail.description ? detail.description : 'Not provided' %></p>
                                <p class="mb-2"><strong>Fit &amp; material:</strong>
                                  <%= detail.fitType ? detail.fitType : 'Not provided' %> / <%= detail.material ? detail.material : 'Not provided' %>
                                </p>
                                <p class="mb-2"><strong>Available sizes:</strong>
                                  <%= detail.sizeRange ? detail.sizeRange : 'Not provided' %>
                                </p>
                                <p class="mb-3"><strong>Color:</strong>
                                  <%= detail.color ? detail.color : 'Not provided' %>
                                </p>
                                <div class="text-muted">
                                  <div>Care instructions:</div>
                                  <% if (detail.care) { %>
                                    <div><%= detail.care %></div>
                                    <% } else { %>
                                      <div>Not provided</div>
                                      <% } %>
                                </div>
                              </div>
                            </div>

                            <div class="card shadow-sm mt-4" id="size-guide">
                              <div class="card-body">
                                <h3 class="card-title mb-3">Size guide</h3>
                                <p class="text-muted mb-3">Use chest measurement as the most accurate indicator.</p>
                                <div class="row g-2">
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">XS - 84 cm</div>
                                  </div>
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">S - 84-92 cm</div>
                                  </div>
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">M - 92-100 cm</div>
                                  </div>
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">L - 100-108 cm</div>
                                  </div>
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">XL - 108-116 cm</div>
                                  </div>
                                  <div class="col-6 col-md-4">
                                    <div class="border rounded-3 p-2 text-center">2XL+ - 116 cm+</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="col-12 col-lg-5">
                            <div class="card shadow-sm">
                              <div class="card-body">
                                <h3 class="card-title mb-3">Delivery & returns</h3>
                                <p class="text-muted mb-2">Delivery estimate: 2-4 business days within Singapore.</p>
                                <p class="text-muted mb-3">Returns accepted within 14 days for unworn items with tags.</p>
                                <% if (typeof canReturn !== 'undefined' && canReturn && typeof orderId !== 'undefined') { %>
                                  <a href="/order/<%= orderId %>/return" class="btn btn-outline-primary">Request return/exchange</a>
                                  <% } %>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row g-4 mt-4">
                          <div class="col-12">
                            <div class="d-flex flex-wrap justify-content-between align-items-end mb-3">
                              <div>
                                <h3 class="mb-1">You may also like</h3>
                                <p class="text-muted mb-0">More styles curated for your next look.</p>
                              </div>
                            </div>
                            <% if (typeof relatedProducts !== 'undefined' && relatedProducts && relatedProducts.length) { %>
                              <div class="row g-3">
                                <% relatedProducts.slice(0, 3).forEach(function(item) { %>
                                  <div class="col-12 col-md-6 col-lg-4">
                                    <div class="card h-100 shadow-sm">
                                      <% if (item.image) { %>
                                        <img src="/images/<%= item.image %>" class="card-img-top"
                                          alt="<%= item.productName || item.name %>">
                                        <% } else { %>
                                          <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                            style="height: 200px;">
                                            <span class="text-muted">No image available</span>
                                          </div>
                                          <% } %>
                                      <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">
                                          <a href="/product/<%= item.id %>" class="text-decoration-none text-dark">
                                            <%= item.productName || item.name %>
                                          </a>
                                        </h5>
                                        <p class="text-muted mb-3">Fresh picks in inclusive sizes.</p>
                                        <div class="mt-auto">
                                          <span class="fw-semibold">$<%= Number(item.effectivePrice || item.price || 0).toFixed(2) %></span>
                                          <a href="/product/<%= item.id %>" class="btn btn-outline-primary w-100 mt-2">View product</a>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                  <% }); %>
                              </div>
                              <% } else { %>
                                <div class="alert alert-light border">More styles coming soon</div>
                                <% } %>
                          </div>
                        </div>

                        <div class="row g-4 mt-4">
                          <div class="col-12 col-lg-6">
                            <div class="card shadow-sm">
                              <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                  <h3 class="card-title mb-0">Customer reviews</h3>
                                  <% if (typeof averageRating==='number' ) { %>
                                    <span class="badge bg-warning text-dark">Avg rating: <%= averageRating.toFixed(1) %>
                                        / 5</span>
                                    <% } %>
                                </div>

                                <% if (user && user.role === 'user') { %>
                                  <form action="/product/<%= product.id %>/reviews" method="POST" class="mb-3">
                                    <div class="mb-3">
                                      <label for="rating" class="form-label">Your Rating</label>
                                      <select name="rating" id="rating" class="form-select" required>
                                        <% for (let score=5; score>= 1; score--) { %>
                                          <option value="<%= score %>" <%=(userReview &&
                                            Number(userReview.rating)===score) ? 'selected' : '' %>>
                                            <%= score %> star<%= score> 1 ? 's' : '' %>
                                          </option>
                                          <% } %>
                                      </select>
                                    </div>
                                    <div class="mb-3">
                                      <label for="comment" class="form-label">Your Review</label>
                                      <textarea name="comment" id="comment" rows="4" class="form-control"
                                        placeholder="Share your experience"><%= userReview ? userReview.comment : '' %></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                      <button type="submit" class="btn btn-primary">
                                        <%= userReview ? 'Update review' : 'Submit review' %>
                                      </button>
                                      <% if (userReview) { %>
                                        <button type="submit" form="delete-review-form"
                                          class="btn btn-outline-danger">Delete review</button>
                                        <% } %>
                                    </div>
                                  </form>
                                  <% if (userReview) { %>
                                    <form id="delete-review-form"
                                      action="/product/<%= product.id %>/reviews/<%= userReview.id %>/delete"
                                      method="POST"></form>
                                    <% } %>
                                      <% } else { %>
                                        <p class="text-muted mb-4">Sign in as a shopper to share your thoughts about
                                          this shirt!</p>
                                        <% } %>

                                          <% if (reviews && reviews.length) { %>
                                            <div class="list-group">
                                              <% reviews.forEach(function(review) { %>
                                                <div class="list-group-item list-group-item-action">
                                                  <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                      <strong>
                                                        <%= review.username %>
                                                      </strong>
                                                      <span class="ms-2 badge bg-warning text-dark">
                                                        <%= review.rating %> / 5
                                                      </span>
                                                    </div>
                                                    <small class="text-muted">
                                                      <%= new Date(review.created_at).toLocaleString() %>
                                                    </small>
                                                  </div>
                                                  <% if (review.comment) { %>
                                                    <p class="mb-0 mt-2">
                                                      <%= review.comment %>
                                                    </p>
                                                    <% } else { %>
                                                      <p class="mb-0 mt-2 text-muted fst-italic">No comments provided.
                                                      </p>
                                                      <% } %>
                                                </div>
                                                <% }); %>
                                            </div>
                                            <% } else { %>
                                              <p class="text-muted mb-0">No reviews yet. Be the first to share your
                                                experience!</p>
                                              <% } %>
                              </div>
                            </div>
                          </div>
                        </div>
                        <% } else { %>
                          <div class="empty-state">
                            <h3>Product not found</h3>
                            <p class="text-muted">The product you are looking for is no longer available.</p>
                            <a href="/shopping" class="btn btn-primary">Browse shirts</a>
                          </div>
                          <% } %>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <small>&copy; <%= new Date().getFullYear() %> Shirt Shop</small>
    </div>
  </footer>
</body>

</html>
