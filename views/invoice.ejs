<% const displayOrderNumber = order && (order.order_number || order.id); const invoiceHeading = displayOrderNumber ? `Invoice #${displayOrderNumber}` : 'Invoice'; const pageTitle=`${invoiceHeading} | Shirt Shop`; const slotLabels = { '09:00-12:00': '9:00 AM - 12:00 PM', '12:00-15:00': '12:00 PM - 3:00 PM', '15:00-18:00': '3:00 PM - 6:00 PM' }; const slotWindowLabel = order && order.delivery_slot_window ? (slotLabels[order.delivery_slot_window] || order.delivery_slot_window) : null; const extraHead=` <style>
  body {
  background: #f5f7fb;
  color: #0f172a;
  }

  .invoice-card {
  max-width: 900px;
  margin: 2rem auto;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 24px 60px rgba(15, 23, 42, 0.14);
  border: 1px solid rgba(15, 23, 42, 0.05);
  overflow: hidden;
  }

  .invoice-header {
  background: linear-gradient(135deg, rgba(255, 122, 89, 0.12), rgba(46, 197, 206, 0.12));
  padding: 1.6rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  }

  .invoice-meta span {
  display: block;
  color: #4b5563;
  }

  .table-invoice th {
  background: #f8fafc;
  }

  .badge-soft {
  background: rgba(255, 122, 89, 0.12);
  color: #b45309;
  border: 1px solid rgba(255, 122, 89, 0.3);
  }

  @media print {
  body {
  background: #fff;
  }

  .print-actions {
  display: none;
  }

  .invoice-card {
  box-shadow: none;
  border: 1px solid #e5e7eb;
  }
  }
  </style>
  `;
  %>
  <%- include('partials/header', { title: pageTitle, extraHead }) %>
    <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>
      <div class="print-actions text-center mt-3">
        <a href="<%= (user && user.role === 'admin') ? '/admin/deliveries' : '/orders/history' %>"
          class="btn btn-outline-secondary btn-sm me-2">Back</a>
        <button onclick="window.print()" class="btn btn-primary btn-sm">Print invoice</button>
      </div>

      <div class="invoice-card">
        <div class="invoice-header">
          <div>
            <h4 class="mb-0">Shirt Shop</h4>
            <small class="text-muted">Quality shirts delivered</small>
          </div>
          <div class="invoice-meta text-end">
            <% const invoiceLabel = (user && user.role === 'admin' && order.order_number) ? `Invoice #${displayOrderNumber} (ID: ${order.id})` : `Invoice #${displayOrderNumber}`; %>
            <span class="fw-bold"><%= invoiceLabel %></span>
            <span>Date: <%= new Date(order.created_at).toLocaleString() %></span>
            <span>Total: $<%= Number(order.total_amount || order.total || 0).toFixed(2) %></span>
            <% if (refund && refund.refundedAmount > 0) { %>
              <span class="badge bg-info-subtle text-info mt-1">
                <%= refund.isRefunded ? 'Refunded' : 'Partial refund' %>
              </span>
              <% if (refund.refundDate) { %>
                <span class="text-muted small">Refunded on <%= new Date(refund.refundDate).toLocaleDateString() %></span>
              <% } %>
            <% } %>
          </div>
        </div>

        <div class="p-4">
          <div class="row g-4">
            <div class="col-md-6">
              <h6 class="text-uppercase text-muted small">Billed to</h6>
              <p class="mb-1 fw-semibold">
                <%= customer.username || 'Customer' %>
              </p>
              <p class="mb-1 text-muted">
                <%= customer.email || '' %>
              </p>
              <p class="mb-1 text-muted">
                <%= customer.phone || '' %>
              </p>
              <p class="mb-0 text-muted">
                <%= (order.delivery_address || customer.address || 'Address not provided' ) %>
              </p>
            </div>
            <div class="col-md-6 text-md-end">
              <h6 class="text-uppercase text-muted small">Delivery</h6>
              <p class="mb-1">
                <span class="badge badge-soft">
                  <%= order.delivery_method==='delivery' ? 'Delivery' : 'Pickup' %>
                </span>
              </p>
              <p class="mb-1 text-muted">Fee: <%= Number(order.delivery_fee || 0)> 0 ? '$' +
                  Number(order.delivery_fee).toFixed(2) : 'Free' %></p>
              <% if (order.delivery_slot_date && slotWindowLabel) { %>
                <p class="mb-1 text-muted">Slot: <%= new Date(order.delivery_slot_date).toLocaleDateString() %> - <%= slotWindowLabel %></p>
                <% } %>
                  <% if (order.order_notes) { %>
                    <p class="mb-1 text-muted">Notes: <%= order.order_notes %></p>
                    <% } %>
            </div>
          </div>

          <div class="table-responsive mt-4">
            <table class="table table-bordered align-middle table-invoice">
              <thead>
                <tr>
                  <th scope="col">Item</th>
                  <th scope="col" class="text-center">Qty</th>
                  <th scope="col" class="text-end">Price</th>
                  <th scope="col" class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <% if (items && items.length) { %>
                  <% items.forEach(function(item) { %>
                    <tr>
                      <td>
                        <%= item.productName %>
                      </td>
                      <td class="text-center">
                        <%= item.quantity %>
                      </td>
                      <td class="text-end">$<%= Number(item.price).toFixed(2) %>
                      </td>
                      <td class="text-end">$<%= (Number(item.price) * Number(item.quantity)).toFixed(2) %>
                      </td>
                    </tr>
                    <% }); %>
                      <% } else { %>
                        <tr>
                          <td colspan="4" class="text-center text-muted">No items recorded for this order.</td>
                        </tr>
                        <% } %>
              </tbody>
            </table>
          </div>

          <div class="row mt-4">
            <div class="col-md-6">
              <p class="text-muted small mb-0">Thank you for shopping with us. For support, contact
                support@shirtshop.local.
              </p>
            </div>
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal</span>
                    <span class="fw-semibold">$<%= totals.subtotal.toFixed(2) %></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Delivery</span>
                    <span class="fw-semibold">
                      <%= totals.deliveryFee> 0 ? '$' + totals.deliveryFee.toFixed(2) : 'Free' %>
                    </span>
                  </div>
                  <% if (loyalty && Number(loyalty.loyaltyDiscountAmount || 0) > 0) { %>
                    <div class="d-flex justify-content-between mb-2 text-success">
                      <span>EcoPoints discount</span>
                      <span class="fw-semibold">- $<%= Number(loyalty.loyaltyDiscountAmount).toFixed(2) %></span>
                    </div>
                    <% } %>
                      <% if (loyalty && (Number(loyalty.earnedPoints || 0) > 0 || Number(loyalty.redeemedPoints || 0) > 0)) { %>
                        <div class="d-flex justify-content-between small text-muted mb-1">
                          <span>EcoPoints earned</span>
                          <span>+<%= Number(loyalty.earnedPoints || 0) %> EcoPoints</span>
                        </div>
                        <div class="d-flex justify-content-between small text-muted mb-2">
                          <span>EcoPoints redeemed</span>
                          <span>-<%= Number(loyalty.redeemedPoints || 0) %> EcoPoints</span>
                        </div>
                        <% } %>
                  <hr>
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold">Total</span>
                    <span class="fw-bold">$<%= totals.total %></span>
                  </div>
                  <% if (refund && refund.refundedAmount > 0) { %>
                    <div class="d-flex justify-content-between text-danger mt-2">
                      <span>Refunded amount</span>
                      <span class="fw-semibold">-$<%= totals.refundedAmount.toFixed(2) %></span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <span class="fw-bold">Net paid</span>
                      <span class="fw-bold">$<%= totals.netPaid.toFixed(2) %></span>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%- include('partials/footer') %>
