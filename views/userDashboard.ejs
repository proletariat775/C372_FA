<%- include('partials/header', { title: 'User | Shirt Shop' }) %>
    <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>

        <main class="page-section">
            <div class="container">
                <% if (messages && messages.length) { %>
                    <% messages.forEach(function(message) { %>
                        <div class="alert alert-success">
                            <%= message %>
                        </div>
                        <% }); %>
                            <% } %>

                                <% if (errors && errors.length) { %>
                                    <% errors.forEach(function(error) { %>
                                        <div class="alert alert-danger">
                                            <%= error %>
                                        </div>
                                        <% }); %>
                                            <% } %>

                                                <div class="account-wrapper">
                                                    <div class="account-shell">
                                                        <% const selectedTab = (typeof activeTab !== 'undefined' && activeTab)
                                                            ? String(activeTab)
                                                            : 'account';
                                                           const isTab = (name) => selectedTab === name;
                                                        %>

                                                        <aside class="account-sidebar">
                                                        <div class="account-sidebar__card">
                                                            <div class="account-sidebar__title">Account</div>
                                                            <div class="account-nav" id="userTabs" role="tablist" aria-label="Account navigation">
                                                                <a class="account-nav-link <%= isTab('account') ? 'active' : '' %>" id="tab-user-info"
                                                                    href="/user?tab=account"
                                                                    role="tab" aria-controls="panel-user-info"
                                                                    aria-selected="<%= isTab('account') ? 'true' : 'false' %>">Account</a>
                                                                <a class="account-nav-link <%= isTab('orders') ? 'active' : '' %>" id="tab-purchase-history"
                                                                    href="/user?tab=orders"
                                                                    role="tab" aria-controls="panel-purchase-history"
                                                                    aria-selected="<%= isTab('orders') ? 'true' : 'false' %>">Orders</a>
                                                                <a class="account-nav-link <%= isTab('returns') ? 'active' : '' %>" id="tab-refunds"
                                                                    href="/user?tab=returns"
                                                                    role="tab" aria-controls="panel-refunds"
                                                                    aria-selected="<%= isTab('returns') ? 'true' : 'false' %>">Refunds</a>
                                                                <a class="account-nav-link <%= isTab('reviews') ? 'active' : '' %>" id="tab-reviews"
                                                                    href="/user?tab=reviews"
                                                                    role="tab" aria-controls="panel-reviews"
                                                                    aria-selected="<%= isTab('reviews') ? 'true' : 'false' %>">Reviews</a>
                                                            </div>
                                                        </div>
                                                    </aside>

                                                        <section class="account-main">
                                                        <div class="account-crumbs">Account / My Account</div>
                                                        <div class="account-main__header">
                                                            <div>
                                                                <h2 class="mb-1">My Account</h2>
                                                                <p class="text-muted mb-0">Manage your profile, orders, and rewards.</p>
                                                            </div>
                                                            <a href="/user/coupons" class="btn btn-outline-secondary btn-sm">View available coupons</a>
                                                        </div>

                                                        <div class="tab-content account-content" id="userTabsContent">
                                                    <div class="tab-pane fade <%= isTab('account') ? 'show active' : '' %>" id="panel-user-info"
                                                        role="tabpanel" aria-labelledby="tab-user-info"
                                                        style="<%= isTab('account') ? '' : 'display:none;' %>">
                                                        <% const displayName = (profile.first_name || profile.last_name)
                                                            ? `${profile.first_name || ''} ${profile.last_name || ''}`.trim()
                                                            : (profile.username || 'Member');
                                                           const greetingName = profile.first_name || profile.username || 'there';
                                                           const initials = displayName
                                                            .split(' ')
                                                            .filter(Boolean)
                                                            .slice(0, 2)
                                                            .map(word => word[0].toUpperCase())
                                                            .join('') || (profile.username ? profile.username[0].toUpperCase() : 'U');
                                                           const memberSince = profile.created_at ? new Date(profile.created_at).toLocaleDateString() : null;
                                                           const orderCount = orders ? orders.length : 0;
                                                           const refundCount = refundRequests ? refundRequests.length : 0;
                                                           const reviewCount = userReviews ? userReviews.length : 0;
                                                           const ecoBalance = Number(profile.loyalty_points || (user && user.loyalty_points) || 0);
                                                        %>

                                                        <div class="account-card account-hero">
                                                            <div class="account-hero__title">Hi, <%= greetingName %></div>
                                                            <div class="account-profile">
                                                                <div class="account-profile__left">
                                                                    <div class="account-avatar"><%= initials %></div>
                                                                    <div class="account-profile__meta">
                                                                        <div class="account-profile__name"><%= displayName %></div>
                                                                        <div class="text-muted"><%= profile.email || '' %></div>
                                                                        <% if (memberSince) { %>
                                                                            <div class="small text-muted">Member since <%= memberSince %></div>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                                <div class="account-profile__actions">
                                                                    <a href="#account-details" class="btn btn-outline-secondary btn-sm">Edit profile</a>
                                                                </div>
                                                            </div>
                                                            <div class="account-metrics">
                                                                <div class="account-metric">
                                                                    <div class="account-metric__label">Orders</div>
                                                                    <div class="account-metric__value"><%= orderCount %></div>
                                                                </div>
                                                                <div class="account-metric">
                                                                    <div class="account-metric__label">Refund requests</div>
                                                                    <div class="account-metric__value"><%= refundCount %></div>
                                                                </div>
                                                                <div class="account-metric">
                                                                    <div class="account-metric__label">Reviews</div>
                                                                    <div class="account-metric__value"><%= reviewCount %></div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="account-card account-contact">
                                                            <div class="account-contact__row">
                                                                <div class="account-contact__icon">
                                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                                                        <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.4 19.4 0 0 1-6-6 19.8 19.8 0 0 1-3.1-8.7A2 2 0 0 1 4.1 2h3a2 2 0 0 1 2 1.7c.1.7.3 1.4.5 2.1a2 2 0 0 1-.5 2.1L8 9a16 16 0 0 0 7 7l1.1-1.1a2 2 0 0 1 2.1-.5c.7.2 1.4.4 2.1.5a2 2 0 0 1 1.7 2z" />
                                                                    </svg>
                                                                </div>
                                                                <div class="account-contact__info">
                                                                    <div class="account-contact__label">Primary contact</div>
                                                                    <div class="account-contact__value">
                                                                        <span><%= profile.phone || 'No phone saved' %></span>
                                                                        <span class="account-contact__divider">â€¢</span>
                                                                        <span><%= profile.address || 'No address on file' %></span>
                                                                    </div>
                                                                </div>
                                                                <div class="account-contact__actions">
                                                                    <a href="#account-details" class="btn btn-outline-secondary btn-sm">Edit address</a>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="account-card account-ecopoints">
                                                            <div class="account-card__header">
                                                                <div>
                                                                    <h5 class="mb-1">EcoPoints</h5>
                                                                    <p class="text-muted mb-0">Track and redeem your loyalty points.</p>
                                                                </div>
                                                                <span class="account-ecopoints__badge">
                                                                    <span class="badge bg-success-subtle text-success fs-6"><%= ecoBalance %> EcoPoints</span>
                                                                </span>
                                                            </div>
                                                            <div class="account-ecopoints__grid">
                                                                <div class="account-ecopoints__panel">
                                                                    <h6 class="text-uppercase text-muted small mb-2">How to earn EcoPoints</h6>
                                                                    <ul class="account-ecopoints__list">
                                                                        <li>Earn 1 EcoPoint for every $1 spent on paid orders.</li>
                                                                        <li>Get a bonus +50 EcoPoints for every completed order.</li>
                                                                        <li>Earn +10 EcoPoints for each product review (1 reward per item).</li>
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                            <small class="text-muted d-block mt-2">Redeem 100 EcoPoints for $5 off at checkout.</small>
                                                        </div>

                                                        <div class="account-card account-details" id="account-details">
                                                            <div class="account-card__header">
                                                                <div>
                                                                    <h5 class="mb-1">Account Details</h5>
                                                                    <p class="text-muted mb-0">Update your profile information below.</p>
                                                                </div>
                                                            </div>
                                                            <form action="/user/update" method="POST" class="row g-3 account-form">
                                                            <div class="col-md-6">
                                                                <label for="username"
                                                                    class="form-label">Username</label>
                                                                <input type="text" id="username" name="username"
                                                                    class="form-control" required
                                                                    value="<%= profile.username || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="email" class="form-label">Email</label>
                                                                <input type="email" id="email" name="email"
                                                                    class="form-control" required
                                                                    value="<%= profile.email || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="first_name" class="form-label">First
                                                                    name</label>
                                                                <input type="text" id="first_name" name="first_name"
                                                                    class="form-control"
                                                                    value="<%= profile.first_name || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="last_name" class="form-label">Last
                                                                    name</label>
                                                                <input type="text" id="last_name" name="last_name"
                                                                    class="form-control"
                                                                    value="<%= profile.last_name || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="phone" class="form-label">Phone</label>
                                                                <input type="text" id="phone" name="phone"
                                                                    class="form-control" required
                                                                    value="<%= profile.phone || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="address" class="form-label">Address</label>
                                                                <input type="text" id="address" name="address"
                                                                    class="form-control"
                                                                    value="<%= profile.address || '' %>">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="city" class="form-label">City</label>
                                                                <input type="text" id="city" name="city"
                                                                    class="form-control"
                                                                    value="<%= profile.city || '' %>">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="state" class="form-label">State</label>
                                                                <input type="text" id="state" name="state"
                                                                    class="form-control"
                                                                    value="<%= profile.state || '' %>">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="zip_code" class="form-label">ZIP /
                                                                    Postal</label>
                                                                <input type="text" id="zip_code" name="zip_code"
                                                                    class="form-control"
                                                                    value="<%= profile.zip_code || '' %>">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="country" class="form-label">Country</label>
                                                                <input type="text" id="country" name="country"
                                                                    class="form-control"
                                                                    value="<%= profile.country || '' %>">
                                                            </div>
                                                            <div class="col-12 d-flex justify-content-end">
                                                                <button type="submit" class="btn btn-primary">Save
                                                                    changes</button>
                                                            </div>
                                                        </form>
                                                        </div>
                                                    </div>

                                                    <div class="tab-pane fade <%= isTab('orders') ? 'show active' : '' %>" id="panel-purchase-history"
                                                        role="tabpanel" aria-labelledby="tab-purchase-history"
                                                        style="<%= isTab('orders') ? '' : 'display:none;' %>">
                                                        <div class="account-card">
                                                            <div class="account-card__header">
                                                                <div>
                                                                    <h4 class="mb-1">Purchase History</h4>
                                                                    <p class="text-muted mb-0">Review your past orders, track deliveries, and download invoices.</p>
                                                                </div>
                                                            </div>

                                                            <% if (!orders || !orders.length) { %>
                                                                <div class="alert alert-info mb-0">No orders yet.</div>
                                                                <% } else { %>
                                                                    <div class="order-history-toolbar">
                                                                        <div class="order-history-filters">
                                                                            <div class="order-filter">
                                                                                <label for="order-status-filter">Filter status</label>
                                                                                <select class="form-select form-select-sm" id="order-status-filter">
                                                                                    <option value="all" selected>All Orders</option>
                                                                                      <option value="processing">Processing</option>
                                                                                      <option value="packing">Packing</option>
                                                                                      <option value="ready_for_pickup">Ready for pickup</option>
                                                                                      <option value="shipped">Shipped</option>
                                                                                      <option value="delivered">Delivered</option>
                                                                                      <option value="completed">Completed</option>
                                                                                      <option value="refunded">Refunded</option>
                                                                                      <option value="cancelled">Cancelled</option>
                                                                                      <option value="returned">Returned</option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="order-filter order-filter--search">
                                                                                <label for="order-search">Search orders</label>
                                                                                <div class="order-search">
                                                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                                                        <circle cx="11" cy="11" r="8"></circle>
                                                                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                                                    </svg>
                                                                                    <input class="form-control form-control-sm" type="text" id="order-search" placeholder="Search by order # or product">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                          <div class="order-history-note small text-muted">
                                                                             Refunds are available within <%= refundWindowDays || 14 %> days for paid, delivered or completed orders.
                                                                          </div>
                                                                    </div>
                                                                    <div class="order-history-count small text-muted" id="order-filter-count"></div>

                                                                    <div class="order-history-list" id="order-history-list">
                                                                        <% orders.forEach(function(order) { %>
                                                                            <% const items=orderItems[order.id] || []; %>
                                                                            <% const productNames=items.map(item => item.productName).join(' '); %>
                                                                            <% const orderStatusKey = String(order.status || 'processing').toLowerCase(); %>
                                                                            <% const paymentStatusRaw = order.payment_status ? String(order.payment_status).toLowerCase() : 'pending'; %>
                                                                            <% const refundStatusRaw = order.refund_status ? String(order.refund_status).toLowerCase() : ''; %>
                                                                            <% const isRefundedOrder = ['cancelled','returned'].includes(orderStatusKey) || paymentStatusRaw === 'refunded' || refundStatusRaw === 'completed'; %>
                                                                            <% const displayPaymentStatus = isRefundedOrder ? 'refunded' : paymentStatusRaw; %>
                                                                            <% const paymentLabel = displayPaymentStatus ? displayPaymentStatus.charAt(0).toUpperCase() + displayPaymentStatus.slice(1) : 'Pending'; %>
                                                                            <% const paymentClasses = { paid: 'bg-success-subtle text-success', pending: 'bg-warning-subtle text-warning', failed: 'bg-danger-subtle text-danger', refunded: 'bg-info-subtle text-info' }; %>
                                                                            <% const refundLabel = refundStatusRaw ? refundStatusRaw.charAt(0).toUpperCase() + refundStatusRaw.slice(1) : ''; %>
                                                                            <% const refundClasses = { pending: 'bg-warning-subtle text-warning', approved: 'bg-info-subtle text-info', completed: 'bg-success-subtle text-success', rejected: 'bg-danger-subtle text-danger', failed: 'bg-danger-subtle text-danger' }; %>
                                                                            <% const statusLabels = { processing: 'Processing', packing: 'Packing', ready_for_pickup: 'Ready for pickup', shipped: 'Shipped', delivered: 'Delivered', completed: 'Completed', cancelled: 'Cancelled', returned: 'Returned' }; %>
                                                                            <% const filterStatus = isRefundedOrder ? 'refunded' : (orderStatusKey || 'processing'); %>
                                                                            <% const createdAt = order.created_at ? new Date(order.created_at) : null; %>
                                                                            <% const completedAt = order.completed_at ? new Date(order.completed_at) : null; %>
                                                                            <% const referenceDate = completedAt && !Number.isNaN(completedAt.getTime()) ? completedAt : createdAt; %>
                                                                            <% const withinWindow = referenceDate && !Number.isNaN(referenceDate.getTime()) ? (Date.now() - referenceDate.getTime()) <= ((refundWindowDays || 14) * 24 * 60 * 60 * 1000) : true; %>
                                                                            <% const statusEligible = ['completed','delivered'].includes(orderStatusKey); %>
                                                                            <% const refundEligible = paymentStatusRaw === 'paid' && statusEligible && withinWindow; %>
                                                                            <% const hasOpenRefund = ['pending', 'approved', 'processing'].includes(refundStatusRaw); %>
                                                                            <% const refundRequestId = order.refund_request_id || order.refundRequestId || order.refund_request || (order.refundRequest && order.refundRequest.id); %>
                                                                            <% const hasRefundRequest = Boolean(refundRequestId); %>
                                                                            <% const isFullyRefunded = ['cancelled','returned'].includes(orderStatusKey) || paymentStatusRaw === 'refunded'; %>
                                                                            <% const displayOrderNumber = order.order_number || order.id; %>

                                                                            <div class="order-card <%= isRefundedOrder ? 'order-card--refunded' : '' %>" data-status="<%= filterStatus %>" data-payment="<%= displayPaymentStatus %>" data-order-id="<%= displayOrderNumber %>" data-products="<%= productNames %>">
                                                                                    <div class="order-card__header">
                                                                                    <div class="order-card__meta">
                                                                                        <div class="order-card__title">Order #<%= displayOrderNumber %></div>
                                                                                        <div class="order-card__date"><%= createdAt ? createdAt.toLocaleString() : '-' %></div>
                                                                                    </div>
                                                                                    <div class="order-card__badges">
                                                                                        <% const statusLabel = isRefundedOrder ? 'Refunded' : (statusLabels[orderStatusKey] || orderStatusKey.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase())); %>
                                                                                        <span class="badge bg-primary-subtle text-primary text-uppercase">Status: <%= statusLabel %></span>
                                                                                        <span class="badge <%= paymentClasses[displayPaymentStatus] || 'bg-secondary-subtle text-secondary' %> text-uppercase">Payment: <%= paymentLabel %></span>
                                                                                        <% if (refundStatusRaw) { %>
                                                                                            <span class="badge <%= refundClasses[refundStatusRaw] || 'bg-secondary-subtle text-secondary' %> text-uppercase">Refund: <%= refundLabel %></span>
                                                                                        <% } %>
                                                                                        <span class="badge bg-dark-subtle text-dark">Total: $<%= Number(order.total).toFixed(2) %></span>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="order-card__body">
                                                                                     <% const stepFlow = order.delivery_method === 'pickup'
                                                                                         ? ['processing','packing','ready_for_pickup','completed']
                                                                                         : ['processing','packing','shipped','delivered','completed']; %>
                                                                                     <% const stepLabel = (key) => {
                                                                                         if (key === 'ready_for_pickup') return 'Ready for pickup';
                                                                                         if (key === 'delivered') return 'Delivered';
                                                                                         return key.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
                                                                                     }; %>
                                                                                     <% if (!isRefundedOrder) { %>
                                                                                       <% const stepIndex = stepFlow.indexOf(orderStatusKey); %>
                                                                                       <div class="order-stepper mb-3">
                                                                                           <% stepFlow.forEach(function(step, idx) { %>
                                                                                               <% const isActive = stepIndex >= idx; %>
                                                                                               <% const isCurrent = stepIndex === idx && orderStatusKey !== 'cancelled' && orderStatusKey !== 'returned'; %>
                                                                                               <div class="order-step <%= isActive ? 'order-step--active' : '' %> <%= isCurrent ? 'order-step--current' : '' %>">
                                                                                                   <span class="order-step__dot"></span>
                                                                                                   <span><%= stepLabel(step) %></span>
                                                                                               </div>
                                                                                           <% }); %>
                                                                                       </div>
                                                                                     <% } %>
                                                                                    <% if (items.length) { %>
                                                                                        <div class="order-items">
                                                                                            <% items.forEach(function(item) { %>
                                                                                                <% const imageUrl = item.image ? ('/images/' + item.image) : '/images/shirt-sample-1.svg'; %>
                                                                                                <div class="order-item-row">
                                                                                                    <div class="order-item-image">
                                                                                                        <img src="<%= imageUrl %>" alt="<%= item.productName %>">
                                                                                                    </div>
                                                                                                    <div class="order-item-info">
                                                                                                        <div class="order-item-name fw-semibold"><%= item.productName %></div>
                                                                                                        <div class="order-item-meta">Size: <%= item.size || 'Standard' %><%= item.color ? (' / ' + item.color) : '' %></div>
                                                                                                    </div>
                                                                                                    <div class="order-item-qty">Qty <%= item.quantity %></div>
                                                                                                    <div class="order-item-price">$<%= Number(item.price).toFixed(2) %></div>
                                                                                                </div>
                                                                                            <% }); %>
                                                                                        </div>
                                                                                    <% } else { %>
                                                                                        <p class="text-muted mb-0">No items recorded for this order.</p>
                                                                                    <% } %>

                                                                                    <% if (order.delivery_method === 'delivery') { %>
                                                                                        <% const trackingLink = order.tracking_number ? ('https://track.aftership.com/' + order.tracking_number) : null; %>
                                                                                        <% const showDeliveryNote = order.shipping_provider || order.tracking_number || ['processing','packing'].includes(orderStatusKey); %>
                                                                                        <% if (showDeliveryNote) { %>
                                                                                            <div class="order-delivery-note">
                                                                                                <div class="small text-muted">Delivery to <strong><%= order.delivery_address || 'Address pending' %></strong></div>
                                                                                                <% if (order.shipping_provider || ['processing','packing'].includes(orderStatusKey)) { %>
                                                                                                    <div class="small text-muted">Carrier: <%= order.shipping_provider || 'Assigning soon' %></div>
                                                                                                <% } %>
                                                                                                <% if (order.tracking_number || ['processing','packing'].includes(orderStatusKey)) { %>
                                                                                                    <div class="small text-muted">Tracking: <%= order.tracking_number || 'Pending' %>
                                                                                                        <% if (trackingLink) { %>
                                                                                                            <a href="<%= trackingLink %>" target="_blank" rel="noopener" class="ms-1">Track</a>
                                                                                                        <% } %>
                                                                                                    </div>
                                                                                                <% } %>
                                                                                            </div>
                                                                                        <% } %>
                                                                                    <% } else { %>
                                                                                        <% if (order.status === 'ready_for_pickup') { %>
                                                                                              <div class="order-delivery-note">
                                                                                                  <div class="small text-muted">Ready for pickup. Show Order #<%= displayOrderNumber %> at the counter.</div>
                                                                                              </div>
                                                                                        <% } else if (['processing','packing'].includes(orderStatusKey)) { %>
                                                                                              <div class="order-delivery-note">
                                                                                                  <div class="small text-muted">Pickup order. We will notify you once it is ready.</div>
                                                                                              </div>
                                                                                        <% } %>
                                                                                    <% } %>

                                                                                     <div class="order-actions mt-3">
                                                                                         <a href="/order/<%= order.id %>" class="btn btn-outline-secondary btn-sm">View order</a>
                                                                                         <% if (!isRefundedOrder) { %>
                                                                                           <a href="/orders/<%= order.id %>/invoice" class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener">Invoice</a>
                                                                                         <% } %>
                                                                                         <% const canTrack = order.delivery_method === 'delivery' || order.tracking_number || order.shipping_provider; %>
                                                                                         <% if (canTrack) { %>
                                                                                             <a href="/order/<%= order.id %>/track" class="btn btn-outline-primary btn-sm">Track</a>
                                                                                         <% } %>
                                                                                         <% if (user && user.role === 'customer') { %>
                                                                                             <% if (refundEligible && !hasOpenRefund && !hasRefundRequest && !isFullyRefunded) { %>
                                                                                                 <a href="/refunds/request/<%= order.id %>" class="btn btn-outline-warning btn-sm">Request refund</a>
                                                                                             <% } %>
                                                                                             <% if (hasRefundRequest) { %>
                                                                                                 <a href="/refunds/<%= refundRequestId %>" class="btn btn-outline-secondary btn-sm">View refund details</a>
                                                                                             <% } %>
                                                                                         <% } %>
                                                                                     </div>
                                                                                    <% const refundAmount = Number(order.refunded_amount || order.refund_approved_amount || 0); %>
                                                                                    <% const refundDate = order.refunded_at || order.refund_updated_at; %>
                                                                                    <% if (refundAmount > 0) { %>
                                                                                        <div class="small text-muted mt-2">Refunded $<%= refundAmount.toFixed(2) %><%= refundDate ? (', on ' + new Date(refundDate).toLocaleDateString()) : '' %>.</div>
                                                                                    <% } %>
                                                                                </div>
                                                                            </div>
                                                                        <% }); %>
                                                                    </div>
                                                                    <% } %>
                                                        </div>
                                                    </div>

                                                    <div class="tab-pane fade <%= isTab('returns') ? 'show active' : '' %>" id="panel-refunds" role="tabpanel"
                                                        aria-labelledby="tab-refunds"
                                                        style="<%= isTab('returns') ? '' : 'display:none;' %>">
                                                        <div class="account-card">
                                                            <div class="account-card__header">
                                                                <div>
                                                                    <h4 class="mb-1">Refund requests</h4>
                                                                    <p class="text-muted mb-0">Track refund requests and view details. Start a refund from the Purchase History tab.</p>
                                                                </div>
                                                            </div>

                                                            <% const paymentLabel = (method) => {
                                                                const value = (method || '').toString().toLowerCase();
                                                                if (value === 'paypal') return 'PayPal';
                                                                if (value === 'stripe') return 'Stripe';
                                                                if (value === 'netsqr') return 'NETS QR';
                                                                return method ? method.toUpperCase() : 'Unknown';
                                                            }; %>

                                                            <% if (!refundRequests || refundRequests.length === 0) { %>
                                                                <div class="alert alert-info mb-0">No refund requests yet.</div>
                                                                <% } else { %>
                                                                    <div class="table-responsive">
                                                                        <table class="table align-middle mb-0">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>Request ID</th>
                                                                                    <th>Order</th>
                                                                                    <th>Payment</th>
                                                                                    <th>Requested Amount</th>
                                                                                    <th>Approved Amount</th>
                                                                                    <th>Status</th>
                                                                                    <th>Submitted</th>
                                                                                    <th></th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                <% refundRequests.forEach(function(request) { %>
                                                                                    <tr>
                                                                                        <td class="fw-semibold">#<%= request.id %></td>
                                                                                        <td>Order #<%= request.orderNumber || request.orderId %></td>
                                                                                        <td>
                                                                                            <span
                                                                                                class="badge bg-light text-dark border"><%= paymentLabel(request.paymentMethod) %></span>
                                                                                        </td>
                                                                                        <td>$<%= Number(request.requestedAmount || 0).toFixed(2) %></td>
                                                                                        <td>
                                                                                            <%= request.approvedAmount ? '$' + Number(request.approvedAmount || 0).toFixed(2) : '-' %>
                                                                                        </td>
                                                                                        <td>
                                                                                            <span
                                                                                                class="badge bg-light text-dark border"><%= (request.status || 'UNKNOWN').toUpperCase() %></span>
                                                                                            <% const statusKey = (request.status || '').toLowerCase(); %>
                                                                                            <% if ((statusKey === 'rejected' || statusKey === 'failed') && request.adminNote) { %>
                                                                                                <div class="small text-muted mt-1"><%= request.adminNote %></div>
                                                                                            <% } %>
                                                                                        </td>
                                                                                        <td><%= request.createdAt ? new Date(request.createdAt).toLocaleString() : '-' %></td>
                                                                                        <td>
                                                                                            <a href="/refunds/<%= request.id %>"
                                                                                                class="btn btn-sm btn-outline-primary">View</a>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <% }); %>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                    <% } %>
                                                        </div>
                                                    </div>

                                                    <div class="tab-pane fade <%= isTab('reviews') ? 'show active' : '' %>" id="panel-reviews" role="tabpanel"
                                                        aria-labelledby="tab-reviews"
                                                        style="<%= isTab('reviews') ? '' : 'display:none;' %>">
                                                        <div class="account-card">
                                                            <div class="account-card__header">
                                                                <div>
                                                                    <h4 class="mb-1">My Reviews</h4>
                                                                    <p class="text-muted mb-0">See all the feedback you've shared so far.</p>
                                                                </div>
                                                            </div>

                                                            <% if (!userReviews || userReviews.length === 0) { %>
                                                                <div class="alert alert-info mb-0">You have not submitted any reviews yet.</div>
                                                                <% } else { %>
                                                                    <div class="review-list">
                                                                        <% userReviews.forEach(function(review) { %>
                                                                            <div class="review-item">
                                                                                <div
                                                                                    class="d-flex flex-column flex-md-row justify-content-between gap-2">
                                                                                    <div>
                                                                                        <strong>
                                                                                            <% if (review.productId) { %>
                                                                                                <a href="/product/<%= review.productId %>"
                                                                                                    class="text-decoration-none text-dark"><%= review.productName %></a>
                                                                                                <% } else { %>
                                                                                                    <%= review.productName %>
                                                                                                        <% } %>
                                                                                        </strong>
                                                                                        <div class="small text-muted">
                                                                                            <% if (review.orderId) { %>
                                                                                                Order #<%= review.orderId %> -
                                                                                                <% } %>
                                                                                                    <%= review.createdAt ? new Date(review.createdAt).toLocaleString() : '-' %>
                                                                                        </div>
                                                                                        <% if (review.size || review.color) { %>
                                                                                            <div class="small text-muted">
                                                                                                Variant: <%= review.size || 'Standard' %>
                                                                                                <%= review.color ? ('/ ' + review.color) : '' %>
                                                                                            </div>
                                                                                            <% } %>
                                                                                    </div>
                                                                                    <div class="review-stars"
                                                                                        aria-label="Rating">
                                                                                        <% for (let i=1; i<=5; i++) { %>
                                                                                            <span
                                                                                                class="star <%= i <= Number(review.rating || 0) ? 'filled' : '' %>">&#9733;</span>
                                                                                            <% } %>
                                                                                    </div>
                                                                                </div>
                                                                                <p class="small text-muted mt-2 mb-0">
                                                                                    <%= review.comment || 'No comments provided.' %>
                                                                                </p>
                                                                                <% if (review.orderId) { %>
                                                                                    <div class="mt-2">
                                                                                        <a href="/order/<%= review.orderId %>/review"
                                                                                            class="btn btn-sm btn-outline-secondary">Edit
                                                                                            review</a>
                                                                                    </div>
                                                                                    <% } %>
                                                                            </div>
                                                                            <% }); %>
                                                                    </div>
                                                                    <% } %>
                                                        </div>
                                                    </div>
                                                </section>
                                            </div>
                                        </div>
            </div>
        </main>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var list = document.getElementById('order-history-list');
                if (!list) {
                    return;
                }
                var cards = Array.prototype.slice.call(list.querySelectorAll('.order-card'));
                var statusSelect = document.getElementById('order-status-filter');
                var searchInput = document.getElementById('order-search');
                var countEl = document.getElementById('order-filter-count');

                var applyFilter = function () {
                    var statusValue = statusSelect ? statusSelect.value : 'all';
                    var query = searchInput ? searchInput.value.trim().toLowerCase() : '';
                    var visible = 0;

                    cards.forEach(function (card) {
                        var status = (card.dataset.status || '').toLowerCase();
                        var orderId = (card.dataset.orderId || '').toLowerCase();
                        var products = (card.dataset.products || '').toLowerCase();
                        var matchesStatus = statusValue === 'all' || status === statusValue;
                        var matchesQuery = !query || (orderId + ' ' + products).indexOf(query) !== -1;
                        var show = matchesStatus && matchesQuery;

                        card.classList.toggle('d-none', !show);
                        if (show) {
                            visible += 1;
                        }
                    });

                    if (countEl) {
                        countEl.textContent = 'Showing ' + visible + ' of ' + cards.length + ' orders';
                    }
                };

                if (statusSelect) {
                    statusSelect.addEventListener('change', applyFilter);
                }
                if (searchInput) {
                    searchInput.addEventListener('input', applyFilter);
                }
                applyFilter();
            });
        </script>

        <%- include('partials/footer') %>


