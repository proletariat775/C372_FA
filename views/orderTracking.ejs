<%- include('partials/header', { title: 'Order Tracking | Shirt Shop' }) %>
  <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>

    <main class="page-section">
      <div class="container">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
          <div>
            <% const displayOrderNumber = order.order_number || order.id; %>
            <h2 class="mb-0">Order #<%= displayOrderNumber %>
            </h2>
            <p class="text-muted mb-0">Placed on <%= new Date(order.created_at).toLocaleString() %>
            </p>
          </div>
          <% const statusLabels = { processing: 'Processing', packing: 'Packing', ready_for_pickup: 'Ready for pickup', shipped: 'Shipped', delivered: 'Delivered', completed: 'Completed', cancelled: 'Cancelled', returned: 'Returned' }; %>
          <% const statusKey = String(order.status || 'processing').toLowerCase(); %>
          <% const statusLabel = statusLabels[statusKey] || statusKey.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()); %>
          <% const paymentLabel = String(order.payment_status || 'pending').replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()); %>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary-subtle text-primary text-uppercase">Status: <%= statusLabel %></span>
            <span class="badge bg-dark-subtle text-dark text-uppercase">Payment: <%= paymentLabel %></span>
          </div>
        </div>

        <% if (messages && messages.length) { %>
          <% messages.forEach(function(message) { %>
            <div class="alert alert-success">
              <%= message %>
            </div>
            <% }); %>
              <% } %>

                <% if (errors && errors.length) { %>
                  <% errors.forEach(function(error) { %>
                    <div class="alert alert-danger">
                      <%= error %>
                    </div>
                    <% }); %>
                      <% } %>

                        <div class="row g-3">
                          <div class="col-12 col-lg-7">
                            <div class="card shadow-sm mb-4">
                              <div class="card-body">
                                <h5 class="mb-3">Status timeline</h5>
                                <div class="list-group">
                                  <% (timeline || []).forEach(function(step) { %>
                                    <div
                                      class="list-group-item d-flex justify-content-between align-items-center <%= step.active ? 'list-group-item-success' : '' %>">
                                      <span>
                                        <%= step.label %>
                                      </span>
                                      <span class="badge <%= step.active ? 'bg-success' : 'bg-secondary' %>">
                                        <%= step.active ? 'Active' : 'Upcoming' %>
                                      </span>
                                    </div>
                                    <% }); %>
                                </div>
                              </div>
                            </div>

                            <div class="card shadow-sm">
                              <div class="card-body">
                                <h5 class="mb-3"><%= order.delivery_method === 'pickup' ? 'Pickup details' : 'Shipment details' %></h5>
                                <% if (order.delivery_method === 'pickup') { %>
                                  <% if (order.status === 'ready_for_pickup') { %>
                                    <div class="alert alert-info">Ready for pickup. Show Order #<%= displayOrderNumber %> at the counter.</div>
                                  <% } else { %>
                                    <p class="text-muted mb-1">We will notify you once your pickup is ready.</p>
                                  <% } %>
                                <% } else { %>
                                  <% const trackingLink = order.tracking_number ? ('https://track.aftership.com/' + order.tracking_number) : null; %>
                                  <p class="mb-1"><strong>Carrier:</strong>
                                    <%= order.shipping_provider || 'Pending assignment' %>
                                  </p>
                                  <p class="mb-1"><strong>Tracking number:</strong>
                                    <%= order.tracking_number || 'Not available yet' %>
                                    <% if (trackingLink) { %>
                                      <a href="<%= trackingLink %>" target="_blank" rel="noopener" class="ms-2">Track package</a>
                                    <% } %>
                                  </p>
                                  <p class="mb-0"><strong>Estimated delivery:</strong>
                                    <%= order.est_delivery_date ? new Date(order.est_delivery_date).toLocaleDateString()
                                      : 'TBD' %>
                                  </p>
                                <% } %>
                              </div>
                            </div>
                          </div>
                          <div class="col-12 col-lg-5">
                            <div class="card shadow-sm">
                              <div class="card-body">
                                <h5 class="mb-3">Order totals</h5>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>Subtotal</span>
                                  <strong>$<%= totals.subtotal.toFixed(2) %></strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>Tax</span>
                                  <strong>$<%= totals.tax.toFixed(2) %></strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>Shipping</span>
                                  <strong>$<%= totals.shipping.toFixed(2) %></strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>Discount</span>
                                  <strong>-$<%= totals.discount.toFixed(2) %></strong>
                                </div>
                                <div class="d-flex justify-content-between border-top pt-2">
                                  <span>Total</span>
                                  <strong>$<%= totals.total.toFixed(2) %></strong>
                                </div>
                                <div class="mt-3">
                                  <a href="/order/<%= order.id %>" class="btn btn-outline-primary w-100">Back to
                                    order</a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
      </div>
    </main>
    <%- include('partials/footer') %>
