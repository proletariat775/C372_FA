//I declare that this code was written by me. 
// I will not copy or allow others to copy my code. 
// I understand that copying code is considered as plagiarism.

// Student Name: Zoey Liaw En Yi
// Student ID:24049473
// Class: C372_002_E63C
// Date created: 06/02/2026
<%- include('partials/header', { title: 'Order Tracking | Shirt Shop' }) %>
  <%- include('partials/navbar', { user: typeof user !=='undefined' ? user : null }) %>

    <main class="page-section">
      <div class="container">
        <div class="track-header">
          <div>
            <% const displayOrderNumber = order.order_number || order.id; %>
            <h2 class="mb-1">Track Order</h2>
            <p class="text-muted mb-0">Order #<%= displayOrderNumber %> • Placed on <%= new Date(order.created_at).toLocaleString() %></p>
          </div>
          <% const statusLabels = { processing: 'Processing', packing: 'Packing', ready_for_pickup: 'Ready for pickup', shipped: 'Shipped', delivered: 'Delivered', completed: 'Completed', cancelled: 'Cancelled', returned: 'Returned' }; %>
          <% const statusKey = String(order.status || 'processing').toLowerCase(); %>
          <% const statusLabel = statusLabels[statusKey] || statusKey.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()); %>
          <% const paymentLabel = String(order.payment_status || 'pending').replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()); %>
          <div class="track-badges">
            <span class="badge bg-primary-subtle text-primary text-uppercase">Status: <%= statusLabel %></span>
            <span class="badge bg-dark-subtle text-dark text-uppercase">Payment: <%= paymentLabel %></span>
          </div>
        </div>

        <% if (messages && messages.length) { %>
          <% messages.forEach(function(message) { %>
            <div class="alert alert-success">
              <%= message %>
            </div>
            <% }); %>
              <% } %>

                <% if (errors && errors.length) { %>
                  <% errors.forEach(function(error) { %>
                    <div class="alert alert-danger">
                      <%= error %>
                    </div>
                    <% }); %>
                      <% } %>

                        <div class="row g-3">
                          <div class="col-12">
                            <div class="card shadow-sm mb-4 track-card track-card--primary">
                              <div class="card-body">
                                <div class="track-card__header">
                                  <div>
                                    <div class="small text-muted">Order #<%= displayOrderNumber %></div>
                                    <div class="fw-semibold"><%= new Date(order.created_at).toLocaleString() %></div>
                                  </div>
                                  <span class="badge bg-primary-subtle text-primary"><%= statusLabel %></span>
                                </div>
                                <% const totalSteps = (timeline || []).length; %>
                                <% let activeIndex = -1; %>
                                <% (timeline || []).forEach(function(step, idx) { if (step.active) { activeIndex = idx; } }); %>
                                <% const progressPercent = totalSteps > 1 && activeIndex >= 0 ? (activeIndex / (totalSteps - 1)) * 100 : 0; %>
                                <div class="status-line" style="--progress:<%= progressPercent.toFixed(0) %>%;">
                                  <div class="status-line__track"></div>
                                  <div class="status-line__fill"></div>
                                  <div class="status-line__steps">
                                    <% (timeline || []).forEach(function(step, idx) { %>
                                      <div class="status-line__step <%= step.active ? 'is-active' : '' %> <%= idx === activeIndex ? 'is-current' : '' %>">
                                        <span class="status-line__icon">
                                          <% if (idx === 0) { %>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M4 12h5l2 3h4l2-6h3" />
                                              <circle cx="7" cy="18" r="2" />
                                              <circle cx="17" cy="18" r="2" />
                                            </svg>
                                          <% } else if (idx === totalSteps - 1) { %>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M20 6L9 17l-5-5" />
                                            </svg>
                                          <% } else if (step.label.toLowerCase().includes('pack')) { %>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M3 7l9-4 9 4-9 4-9-4z" />
                                              <path d="M3 7v10l9 4 9-4V7" />
                                            </svg>
                                          <% } else if (step.label.toLowerCase().includes('ship') || step.label.toLowerCase().includes('deliver')) { %>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M3 7h11v8H3z" />
                                              <path d="M14 9h4l3 3v3h-7z" />
                                              <circle cx="7" cy="18" r="2" />
                                              <circle cx="17" cy="18" r="2" />
                                            </svg>
                                          <% } else { %>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M12 3v4" />
                                              <path d="M7 7h10" />
                                              <rect x="4" y="7" width="16" height="12" rx="2" />
                                            </svg>
                                          <% } %>
                                        </span>
                                        <span class="status-line__label"><%= step.label %></span>
                                      </div>
                                    <% }); %>
                                  </div>
                                </div>
                                <div class="track-meta">
                                  <div>
                                    <div class="small text-muted">Payment</div>
                                    <div class="fw-semibold"><%= paymentLabel %></div>
                                  </div>
                                  <div>
                                    <div class="small text-muted">Delivery method</div>
                                    <div class="fw-semibold"><%= order.delivery_method === 'pickup' ? 'Pickup' : 'Delivery' %></div>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="card shadow-sm track-card">
                              <div class="card-body">
                                <h5 class="mb-3"><%= order.delivery_method === 'pickup' ? 'Pickup details' : 'Shipment details' %></h5>
                                <% if (order.delivery_method === 'pickup') { %>
                                  <% if (order.status === 'ready_for_pickup') { %>
                                    <div class="alert alert-success">Ready for pickup. Show Order #<%= displayOrderNumber %> at the counter.</div>
                                    <div class="small text-muted">Estimated pickup date</div>
                                    <div class="fw-semibold"><%= order.est_delivery_date ? new Date(order.est_delivery_date).toLocaleDateString() : 'TBD' %></div>
                                    <div class="small text-muted mt-3">Pickup address</div>
                                    <div class="fw-semibold"><%= order.delivery_address || 'Address to be confirmed' %></div>
                                  <% } else { %>
                                    <div class="small text-muted">Estimated pickup date</div>
                                    <div class="fw-semibold"><%= order.est_delivery_date ? new Date(order.est_delivery_date).toLocaleDateString() : 'TBD' %></div>
                                  <% } %>
                                <% } else { %>
                                  <% const trackingLink = order.tracking_number ? ('https://track.aftership.com/' + order.tracking_number) : null; %>
                                  <div class="track-detail-grid">
                                    <div>
                                      <div class="small text-muted">Shipping provider</div>
                                      <div class="fw-semibold"><%= order.shipping_provider || 'Pending assignment' %></div>
                                    </div>
                                    <div>
                                      <div class="small text-muted">Tracking number</div>
                                      <div class="fw-semibold">
                                        <%= order.tracking_number || 'Not available yet' %>
                                        <% if (trackingLink) { %>
                                          <a href="<%= trackingLink %>" target="_blank" rel="noopener" class="ms-2">Track</a>
                                        <% } %>
                                      </div>
                                    </div>
                                    <div>
                                      <div class="small text-muted">Estimated delivery</div>
                                      <div class="fw-semibold"><%= order.est_delivery_date ? new Date(order.est_delivery_date).toLocaleDateString() : 'TBD' %></div>
                                    </div>
                                  </div>
                                <% } %>
                                <% if (order.admin_notes) { %>
                                  <div class="track-admin-notes mt-3">
                                    <div class="small text-muted">Admin notes</div>
                                    <div class="fw-semibold"><%= order.admin_notes %></div>
                                  </div>
                                <% } %>
                              </div>
                            </div>
                          </div>
                        </div>

    </main>
    <%- include('partials/footer') %>


