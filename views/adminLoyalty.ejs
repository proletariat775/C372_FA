<%- include('partials/header', { title: 'Loyalty Directory | Shirt Shop' }) %>
  <%- include('partials/adminNavbar', { user: typeof user !=='undefined' ? user : null }) %>

    <section class="page-section">
      <div class="container">
        <div class="form-card">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
            <div>
              <h1 class="mb-1">Loyalty directory</h1>
              <p class="text-muted mb-0">Adjust customer loyalty balances with ledger tracking.</p>
            </div>
            <div class="d-flex flex-column align-items-md-end">
              <span class="badge bg-secondary fs-6">Customers: <%= customers ? customers.length : 0 %></span>
              <small class="text-muted mt-1">Total points in circulation: <%= Number(totalPoints || 0) %></small>
            </div>
          </div>

          <div class="alert alert-info py-2">
            Use positive values to add points (e.g. <strong>50</strong>) and negative values to deduct (e.g.
            <strong>-50</strong>).
          </div>

          <% if (errors && errors.length) { %>
            <% errors.forEach(function(error) { %>
              <div class="alert alert-danger">
                <%= error %>
              </div>
              <% }); %>
                <% } %>

                  <% if (messages && messages.length) { %>
                    <% messages.forEach(function(message) { %>
                      <div class="alert alert-success">
                        <%= message %>
                      </div>
                      <% }); %>
                        <% } %>

                          <% if (!customers || customers.length===0) { %>
                            <div class="alert alert-light border mb-0">No customer accounts found.</div>
                            <% } else { %>
                              <div class="table-responsive">
                                <table class="table align-middle">
                                  <thead>
                                    <tr>
                                      <th scope="col">Customer</th>
                                      <th scope="col">Email</th>
                                      <th scope="col">Current points</th>
                                      <th scope="col" style="min-width: 380px;">Adjust points</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% customers.forEach(function(customer) { %>
                                      <tr>
                                        <td>
                                          <strong>
                                            <%= customer.username %>
                                          </strong>
                                          <div class="text-muted small">
                                            <%= customer.first_name || '' %>
                                              <%= customer.last_name || '' %>
                                          </div>
                                        </td>
                                        <td>
                                          <%= customer.email %>
                                        </td>
                                        <td>
                                          <span class="badge bg-primary-subtle text-primary fs-6">
                                            <%= Number(customer.loyalty_points_balance || 0) %> pts
                                          </span>
                                        </td>
                                        <td>
                                          <form action="/admin/loyalty/<%= customer.id %>/adjust" method="POST"
                                            class="row g-2 align-items-center">
                                            <div class="col-12 col-md-4">
                                              <input type="number" name="pointsChange" class="form-control" step="1" required
                                                placeholder="+50 or -50">
                                            </div>
                                            <div class="col-12 col-md-5">
                                              <input type="text" name="note" class="form-control" maxlength="80"
                                                placeholder="Optional note (promo, correction, etc.)">
                                            </div>
                                            <div class="col-12 col-md-3 d-grid">
                                              <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
                                            </div>
                                          </form>
                                        </td>
                                      </tr>
                                      <% }); %>
                                  </tbody>
                                </table>
                              </div>
                              <% } %>
        </div>
      </div>
    </section>

    <%- include('partials/footer') %>
