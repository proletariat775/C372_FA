<%#
I declare that this code was written by me.
I will not copy or allow others to copy my code.
I understand that copying code is considered as plagiarism.

Student Name: Yeo Jun Long Dave
Student ID: 24046757
Class: C372-002
Date created: 06/02/2026
%>

<%- include('partials/header', { title: 'Checkout | Shirt Shop' }) %>
<%- include('partials/navbar', { user: user }) %>

<main class="page-section">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <p class="mb-1 text-muted">Almost there</p>
        <h2 class="mb-0">Checkout</h2>
      </div>
      <a href="/cart" class="btn btn-outline-secondary">Back to cart</a>
    </div>

    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success">
          <%= message %>
        </div>
        <% }); %>
          <% } %>

            <% if (errors && errors.length) { %>
              <% errors.forEach(function(error) { %>
                <div class="alert alert-danger">
                  <%= error %>
                </div>
                <% }); %>
                  <% } %>

                    <% if (!cart || cart.length===0) { %>
                      <div class="empty-state">
                        <h3>Your cart is empty</h3>
                        <p class="text-muted">Add items before heading to checkout.</p>
                        <a href="/shopping" class="btn btn-primary">Browse products</a>
                      </div>
                      <% } else { %>
                        <div class="row g-4">
                          <div class="col-12 col-lg-7">
                            <div class="card checkout-panel">
                              <div class="card-body">
                                <h4 class="mb-3">Order summary</h4>
                                <div class="list-group list-group-flush">
                                  <% cart.forEach(function(item) { %>
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                      <div class="d-flex align-items-center gap-3">
                                        <% if (item.image) { %>
                                          <img src="/images/<%= item.image %>" alt="<%= item.productName %>" width="56"
                                            height="56" class="rounded">
                                          <% } else { %>
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                              style="width:56px;height:56px;">
                                              <span class="text-muted small">No image</span>
                                            </div>
                                            <% } %>
                                              <div>
                                                <div class="fw-semibold">
                                                  <%= item.productName %>
                                                </div>
                                                <div class="text-muted small">Size <%= item.size || 'Standard' %> | Qty <%= item.quantity %></div>
                                              </div>
                                      </div>
                                      <div class="text-end">
                                        <div class="fw-semibold">$<%= Number(item.price).toFixed(2) %></div>
                                        <div class="text-muted small">$<%= (Number(item.price) *
                                            Number(item.quantity)).toFixed(2) %></div>
                                      </div>
                                    </div>
                                    <% }); %>
                                </div>

                                <div class="mt-3">
                                  <div class="d-flex justify-content-between">
                                    <span class="text-muted">Subtotal</span>
                                    <span>$<%= Number(subtotal || 0).toFixed(2) %></span>
                                  </div>
                                  <% if (discountAmount && Number(discountAmount) > 0) { %>
                                    <div class="d-flex justify-content-between text-success">
                                      <span>Coupon discount</span>
                                      <span>- $<%= Number(discountAmount).toFixed(2) %></span>
                                    </div>
                                    <% } %>
                                  <% if (bundleDiscount && Number(bundleDiscount) > 0) { %>
                                        <div class="d-flex justify-content-between text-success">
                                          <span>Bundle discount</span>
                                          <span>- $<%= Number(bundleDiscount).toFixed(2) %></span>
                                        </div>
                                        <% } %>
                                          <% if (loyaltyDiscountAmount && Number(loyaltyDiscountAmount) > 0) { %>
                                            <div class="d-flex justify-content-between text-success">
                                              <span>EcoPoints discount</span>
                                              <span>- $<%= Number(loyaltyDiscountAmount).toFixed(2) %></span>
                                            </div>
                                            <% } %>
                                          <div class="d-flex justify-content-between fw-semibold mt-2">
                                            <span>Total (before delivery)</span>
                                            <span>$<%= Number(baseTotal || 0).toFixed(2) %></span>
                                          </div>
                                </div>

                                <div class="mt-4">
                                  <h6 class="text-uppercase text-muted small mb-2">Discounts</h6>
                                  <% if (appliedCoupon) { %>
                                    <div class="d-flex justify-content-between align-items-center">
                                      <span class="text-success">Coupon applied: <strong><%= appliedCoupon.code %></strong></span>
                                      <span class="badge bg-success-subtle text-success">Saved $<%= Number(appliedCoupon.discountAmount).toFixed(2) %></span>
                                    </div>
                                    <% } else { %>
                                      <p class="text-muted mb-0">No coupon applied.</p>
                                      <% } %>
                                        <% if (bundleDiscount && Number(bundleDiscount) > 0) { %>
                                          <div class="mt-2">
                                            <span class="bundle-discount">Bundle discount: extra 10% off</span>
                                          </div>
                                          <% } %>
                                </div>

                                <div class="mt-4 p-3 rounded border bg-light-subtle">
                                  <div class="d-flex justify-content-between">
                                    <span class="text-muted">EcoPoints balance</span>
                                    <span class="fw-semibold"><%= Number(loyaltyBalance || 0) %> pts</span>
                                  </div>
                                </div>

                                <div class="impact-summary mt-4">
                                  <h5 class="mb-3">Estimated Impact of This Order</h5>
                                  <div class="impact-summary__list">
                                    <div class="impact-item">
                                      <span class="impact-icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                          stroke-linecap="round" stroke-linejoin="round">
                                          <path d="M12 3c3.5 4.5 6 7.6 6 11a6 6 0 1 1-12 0c0-3.4 2.5-6.5 6-11z" />
                                        </svg>
                                      </span>
                                      <span>Water saved: <strong><%= impactSummary.waterSavedLitres %></strong> L</span>
                                    </div>
                                    <div class="impact-item">
                                      <span class="impact-icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                          stroke-linecap="round" stroke-linejoin="round">
                                          <path d="M5 13c4-6 11-8 14-8-1 5-4 12-11 14-3 1-5-1-3-6z" />
                                          <path d="M9 13c2 2 4 3 6 3" />
                                        </svg>
                                      </span>
                                      <span>Textile waste reduced: <strong><%= Number(impactSummary.textileWasteReducedKg || 0).toFixed(1) %></strong> kg</span>
                                    </div>
                                    <div class="impact-item">
                                      <span class="impact-icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                          stroke-linecap="round" stroke-linejoin="round">
                                          <circle cx="12" cy="12" r="9" />
                                          <path d="M3 12h18" />
                                          <path d="M12 3c3 3 3 15 0 18" />
                                        </svg>
                                      </span>
                                      <span>CO2 emissions reduced: <strong><%= Number(impactSummary.carbonReducedKg || 0).toFixed(1) %></strong> kg</span>
                                    </div>
                                  </div>
                                  <small class="text-muted d-block mt-2">Estimated using industry benchmark averages.</small>
                                </div>
                              </div>
                            </div>

                          </div>

                          <div class="col-12 col-lg-5">
                            <form action="/checkout" method="POST" class="card checkout-panel">
                              <div class="card-body">
                                <h4 class="mb-3">Delivery method</h4>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="deliveryMethod"
                                      id="checkout-pickup" value="pickup" checked>
                                    <label class="form-check-label" for="checkout-pickup">Store pickup</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="deliveryMethod"
                                      id="checkout-delivery" value="delivery">
                                    <label class="form-check-label" for="checkout-delivery">Island-wide delivery</label>
                                  </div>
                                </div>

                                <div class="mb-3 d-none" id="checkout-delivery-address">
                                  <label for="deliveryAddress" class="form-label">Delivery address</label>
                                  <textarea class="form-control" id="deliveryAddress" name="deliveryAddress" rows="2"
                                    placeholder="Enter delivery address"><%= user && user.address ? user.address : '' %></textarea>
                                  <small class="text-muted">Required when delivery is selected.</small>
                                </div>

                                <div class="mb-3">
                                  <label for="orderNotes" class="form-label">Order notes / Gift message (optional)</label>
                                  <textarea class="form-control" id="orderNotes" name="orderNotes" rows="3" maxlength="200"
                                    placeholder="Add delivery notes or a short gift message (max 200 characters)."></textarea>
                                  <small class="text-muted">Optional. 200 characters max.</small>
                                </div>

                                <div class="alert <%= user && user.free_delivery ? 'alert-success' : 'alert-info' %> py-2">
                                  <% if (user && user.free_delivery) { %>
                                    <strong>Free delivery unlocked.</strong> Delivery fee waived for your account.
                                    <% } else { %>
                                      Delivery adds $<%= Number(deliveryFee || 0).toFixed(2) %> when selected.
                                      <% } %>
                                </div>

                                <% if (loyaltyRedemptionEnabled) { %>
                                  <div class="mb-3">
                                    <h4 class="mb-2">EcoPoints</h4>
                                    <label for="loyaltyPointsToRedeem" class="form-label">Redeem EcoPoints (optional)</label>
                                    <input type="number" id="loyaltyPointsToRedeem" name="loyaltyPointsToRedeem"
                                      class="form-control" min="0" step="100"
                                      value="<%= Number(loyaltyPointsToRedeem || 0) %>">
                                    <small class="text-muted d-block mt-1" id="loyalty-redeem-help">100 EcoPoints = $5.00 discount. Available: <%= Number(loyaltyBalance || 0) %> EcoPoints.</small>
                                  </div>
                                <% } else { %>
                                  <input type="hidden" name="loyaltyPointsToRedeem" value="0">
                                  <div class="alert alert-secondary py-2">
                                    EcoPoints redemption is currently disabled. You still earn EcoPoints on paid orders.
                                  </div>
                                <% } %>

                                <div class="mb-4">
                                  <h4 class="mb-3">Payment method</h4>
                                  <div class="d-grid gap-2">
                                    <% (paymentMethods || []).forEach(function(method) { %>
                                      <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod"
                                          id="payment-<%= method.value %>" value="<%= method.value %>"
                                          <%= (selectedPayment || 'card') === method.value ? 'checked' : '' %> required>
                                        <label class="form-check-label" for="payment-<%= method.value %>">
                                          <%= method.label %>
                                        </label>
                                      </div>
                                      <% }); %>
                                  </div>
                                  <small class="text-muted">PayPal uses sandbox/test credentials.</small>
                                </div>

                                <div class="mb-3">
                                  <div class="d-flex justify-content-between text-success d-none" id="loyalty-discount-row">
                                    <span>EcoPoints discount</span>
                                    <span id="loyalty-discount-amount">- $0.00</span>
                                  </div>
                                  <div class="d-flex justify-content-between">
                                    <span class="text-muted">Estimated total</span>
                                    <span class="fw-semibold" id="checkout-total"
                                      data-base-total="<%= Number(baseTotal || 0).toFixed(2) %>"
                                      data-delivery-fee="<%= Number(deliveryFee || 0).toFixed(2) %>"
                                      data-loyalty-balance="<%= Number(loyaltyBalance || 0) %>"
                                      data-redemption-enabled="<%= loyaltyRedemptionEnabled ? '1' : '0' %>"
                                      data-loyalty-points-per-dollar="20"
                                      data-eco-bonus="50"
                                      data-eco-step="100">
                                      $<%= Number(baseTotal || 0).toFixed(2) %>
                                    </span>
                                  </div>
                                  <div class="small text-muted mt-1 text-end">
                                    EcoPoints reward after payment:
                                    <span class="text-success fw-semibold" id="checkout-estimated-points">+<%= Number(estimatedPointsToEarn || 0) %> pts</span>
                                  </div>
                                </div>

                                <div id="payment-notice" class="alert alert-info d-none mb-3"></div>
                                <button type="submit" class="btn btn-success w-100" id="checkout-submit">Place order / Pay now</button>
                                <div id="paypal-actions" class="d-none mt-2 d-grid">
                                  <button type="button" class="btn btn-primary" id="paypal-button">Pay with PayPal</button>
                                </div>
                                <div id="stripe-actions" class="d-none mt-2 d-grid">
                                  <button type="button" class="btn btn-dark" id="stripe-button">Pay with Stripe</button>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                        <% } %>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var addressGroup = document.getElementById('checkout-delivery-address');
    var notesInput = document.getElementById('orderNotes');
    var totalEl = document.getElementById('checkout-total');
    var radios = document.querySelectorAll('input[name="deliveryMethod"]');
    var paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    var paypalActions = document.getElementById('paypal-actions');
    var stripeActions = document.getElementById('stripe-actions');
    var submitBtn = document.getElementById('checkout-submit');
    var paypalButton = document.getElementById('paypal-button');
    var stripeButton = document.getElementById('stripe-button');
    var notice = document.getElementById('payment-notice');
    var checkoutForm = document.querySelector('form[action="/checkout"]');
    var loyaltyInput = document.getElementById('loyaltyPointsToRedeem');
    var loyaltyHelp = document.getElementById('loyalty-redeem-help');
    var loyaltyDiscountRow = document.getElementById('loyalty-discount-row');
    var loyaltyDiscountAmountEl = document.getElementById('loyalty-discount-amount');
    var estimatedPointsEl = document.getElementById('checkout-estimated-points');

    if (!addressGroup || !totalEl) {
      return;
    }

    var baseTotal = Number(totalEl.dataset.baseTotal || 0);
    var deliveryFee = Number(totalEl.dataset.deliveryFee || 0);
    var loyaltyBalance = Number(totalEl.dataset.loyaltyBalance || 0);
    var redemptionEnabled = totalEl.dataset.redemptionEnabled === '1';
    var pointsPerDollar = Number(totalEl.dataset.loyaltyPointsPerDollar || 20);
    var ecoBonus = Number(totalEl.dataset.ecoBonus || 0);
    var ecoStep = Number(totalEl.dataset.ecoStep || 100);

    var toWholeNumber = function (value) {
      var parsed = parseInt(value, 10);
      if (!isFinite(parsed) || parsed <= 0) {
        return 0;
      }
      return parsed;
    };

    // Mirrors server-side loyalty redemption limits to keep checkout preview accurate.
    var calculateLoyaltyPreview = function (maxDiscountableAmount) {
      if (!redemptionEnabled) {
        return { requested: 0, points: 0, discount: 0, message: '' };
      }

      var requested = toWholeNumber(loyaltyInput ? loyaltyInput.value : 0);
      if (requested <= 0) {
        return { requested: 0, points: 0, discount: 0, message: '' };
      }

      var maxPointsByAmount = Math.floor(Math.max(0, maxDiscountableAmount) * pointsPerDollar);
      var maxRedeemable = Math.floor(Math.min(loyaltyBalance, maxPointsByAmount) / ecoStep) * ecoStep;
      if (maxRedeemable <= 0) {
        return {
          requested: requested,
          points: 0,
          discount: 0,
          message: 'This order is not eligible for EcoPoints redemption.'
        };
      }

      if (requested % ecoStep !== 0) {
        return {
          requested: requested,
          points: 0,
          discount: 0,
          message: 'EcoPoints can be redeemed in ' + ecoStep + '-point increments.'
        };
      }

      if (requested > loyaltyBalance) {
        return {
          requested: requested,
          points: 0,
          discount: 0,
          message: 'You requested more EcoPoints than your available balance.'
        };
      }

      if (requested > maxRedeemable) {
        return {
          requested: requested,
          points: 0,
          discount: 0,
          message: 'Requested EcoPoints exceed this order total.'
        };
      }

      var points = requested;
      return {
        requested: requested,
        points: points,
        discount: Number((points / pointsPerDollar).toFixed(2)),
        message: ''
      };
    };

    var updateTotals = function () {
      var selected = document.querySelector('input[name="deliveryMethod"]:checked');
      var isDelivery = selected && selected.value === 'delivery';
      addressGroup.classList.toggle('d-none', !isDelivery);

      var totalBeforeLoyalty = isDelivery ? baseTotal + deliveryFee : baseTotal;
      var loyalty = calculateLoyaltyPreview(totalBeforeLoyalty);
      var nextTotal = Math.max(0, totalBeforeLoyalty - loyalty.discount);

      totalEl.textContent = '$' + nextTotal.toFixed(2);

      if (loyaltyDiscountRow && loyaltyDiscountAmountEl) {
        loyaltyDiscountAmountEl.textContent = '- $' + loyalty.discount.toFixed(2);
        loyaltyDiscountRow.classList.toggle('d-none', loyalty.discount <= 0);
      }

      if (estimatedPointsEl) {
        var basePoints = Math.max(0, Math.floor(nextTotal));
        var estimated = nextTotal > 0 ? basePoints + ecoBonus : 0;
        estimatedPointsEl.textContent = '+' + estimated + ' pts';
      }

      if (loyaltyHelp) {
        loyaltyHelp.textContent = loyalty.message || ('100 EcoPoints = $5.00 discount. Available: ' + loyaltyBalance + ' EcoPoints.');
      }
    };

    radios.forEach(function (radio) {
      radio.addEventListener('change', updateTotals);
    });

    if (loyaltyInput) {
      loyaltyInput.addEventListener('input', updateTotals);
      loyaltyInput.addEventListener('change', updateTotals);
    }

    updateTotals();

    var showNotice = function (message, type) {
      if (!notice) return;
      notice.textContent = message;
      notice.className = 'alert alert-' + (type || 'info');
      notice.classList.remove('d-none');
    };

    var clearNotice = function () {
      if (!notice) return;
      notice.classList.add('d-none');
    };

    var currentPayment = function () {
      var selected = document.querySelector('input[name="paymentMethod"]:checked');
      return selected ? selected.value : '';
    };

    var updatePaymentActions = function () {
      var payment = currentPayment();
      if (submitBtn) {
        submitBtn.classList.toggle('d-none', payment === 'paypal' || payment === 'stripe');
      }
      if (paypalActions) {
        paypalActions.classList.toggle('d-none', payment !== 'paypal');
      }
      if (stripeActions) {
        stripeActions.classList.toggle('d-none', payment !== 'stripe');
      }
      clearNotice();
    };

    if (checkoutForm) {
      checkoutForm.addEventListener('submit', function (event) {
        var payment = currentPayment();
        if (payment === 'paypal' || payment === 'stripe') {
          event.preventDefault();
          showNotice('Please use the PayPal or Stripe button to complete payment.', 'warning');
        }
      });
    }

    if (paymentRadios && paymentRadios.length) {
      paymentRadios.forEach(function (radio) {
        radio.addEventListener('change', updatePaymentActions);
      });
      updatePaymentActions();
    }

    var buildDeliveryPayload = function () {
      var deliverySelected = document.querySelector('input[name="deliveryMethod"]:checked');
      var method = deliverySelected ? deliverySelected.value : 'pickup';
      var addressInput = document.getElementById('deliveryAddress');
      var address = addressInput ? addressInput.value.trim() : '';
      var notes = notesInput ? notesInput.value.trim() : '';

      if (method === 'delivery' && !address) {
        showNotice('Please enter a delivery address.', 'danger');
        return null;
      }

      if (notes && notes.length > 200) {
        showNotice('Order notes must be 200 characters or fewer.', 'danger');
        return null;
      }

      return {
        deliveryMethod: method,
        deliveryAddress: address,
        orderNotes: notes,
        loyaltyPointsToRedeem: toWholeNumber(loyaltyInput ? loyaltyInput.value : 0)
      };
    };

    if (paypalButton) {
      paypalButton.addEventListener('click', function () {
        var payload = buildDeliveryPayload();
        if (!payload) return;

        showNotice('Redirecting to PayPal...', 'info');
        paypalButton.disabled = true;

        fetch('/payments/paypal/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (data && data.approvalUrl) {
              window.location.href = data.approvalUrl;
              return;
            }
            paypalButton.disabled = false;
            showNotice(data && data.message ? data.message : 'Unable to start PayPal checkout.', 'danger');
          })
          .catch(function () {
            paypalButton.disabled = false;
            showNotice('Unable to start PayPal checkout.', 'danger');
          });
      });
    }

    if (stripeButton) {
      stripeButton.addEventListener('click', function () {
        var payload = buildDeliveryPayload();
        if (!payload) return;

        showNotice('Redirecting to Stripe...', 'info');
        stripeButton.disabled = true;

        fetch('/payments/stripe/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (data && data.url) {
              window.location.href = data.url;
              return;
            }
            stripeButton.disabled = false;
            showNotice(data && data.message ? data.message : 'Unable to start Stripe checkout.', 'danger');
          })
          .catch(function () {
            stripeButton.disabled = false;
            showNotice('Unable to start Stripe checkout.', 'danger');
          });
      });
    }

    var params = new URLSearchParams(window.location.search);
    if (params.get('paypal') === 'cancel') {
      window.location.href = '/orders/failed?reason=paypal_cancel';
      return;
    }

    if (params.get('paypal') === '1' && params.get('token')) {
      showNotice('Finalizing PayPal payment...', 'info');
      fetch('/payments/paypal/capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId: params.get('token') })
      })
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (data && data.success) {
            window.location.href = data.redirect || '/orders/success';
            return;
          }
          if (data && data.redirect) {
            window.location.href = data.redirect;
            return;
          }
          showNotice(data && data.message ? data.message : 'Unable to capture PayPal payment.', 'danger');
        })
        .catch(function () {
          window.location.href = '/orders/failed?reason=paypal_error';
        });
    }
  });
</script>

<%- include('partials/footer') %>

