<%- include('partials/header', { title: 'Checkout | Shirt Shop' }) %>
<%- include('partials/navbar', { user: user }) %>

<main class="page-section">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <p class="mb-1 text-muted">Almost there</p>
        <h2 class="mb-0">Checkout</h2>
      </div>
      <a href="/cart" class="btn btn-outline-secondary">Back to cart</a>
    </div>

    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success">
          <%= message %>
        </div>
        <% }); %>
          <% } %>

            <% if (errors && errors.length) { %>
              <% errors.forEach(function(error) { %>
                <div class="alert alert-danger">
                  <%= error %>
                </div>
                <% }); %>
                  <% } %>

                    <% if (!cart || cart.length===0) { %>
                      <div class="empty-state">
                        <h3>Your cart is empty</h3>
                        <p class="text-muted">Add items before heading to checkout.</p>
                        <a href="/shopping" class="btn btn-primary">Browse products</a>
                      </div>
                      <% } else { %>
                        <div class="row g-4">
                          <div class="col-12 col-lg-7">
                            <div class="card checkout-panel">
                              <div class="card-body">
                                <h4 class="mb-3">Order summary</h4>
                                <div class="list-group list-group-flush">
                                  <% cart.forEach(function(item) { %>
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                      <div class="d-flex align-items-center gap-3">
                                        <% if (item.image) { %>
                                          <img src="/images/<%= item.image %>" alt="<%= item.productName %>" width="56"
                                            height="56" class="rounded">
                                          <% } else { %>
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                              style="width:56px;height:56px;">
                                              <span class="text-muted small">No image</span>
                                            </div>
                                            <% } %>
                                              <div>
                                                <div class="fw-semibold">
                                                  <%= item.productName %>
                                                </div>
                                                <div class="text-muted small">Size <%= item.size || 'Standard' %> | Qty <%= item.quantity %></div>
                                              </div>
                                      </div>
                                      <div class="text-end">
                                        <div class="fw-semibold">$<%= Number(item.price).toFixed(2) %></div>
                                        <div class="text-muted small">$<%= (Number(item.price) *
                                            Number(item.quantity)).toFixed(2) %></div>
                                      </div>
                                    </div>
                                    <% }); %>
                                </div>

                                <div class="mt-3">
                                  <div class="d-flex justify-content-between">
                                    <span class="text-muted">Subtotal</span>
                                    <span>$<%= Number(subtotal || 0).toFixed(2) %></span>
                                  </div>
                                  <% if (discountAmount && Number(discountAmount) > 0) { %>
                                    <div class="d-flex justify-content-between text-success">
                                      <span>Coupon discount</span>
                                      <span>- $<%= Number(discountAmount).toFixed(2) %></span>
                                    </div>
                                    <% } %>
                                      <% if (bundleDiscount && Number(bundleDiscount) > 0) { %>
                                        <div class="d-flex justify-content-between text-success">
                                          <span>Bundle discount</span>
                                          <span>- $<%= Number(bundleDiscount).toFixed(2) %></span>
                                        </div>
                                        <% } %>
                                          <div class="d-flex justify-content-between fw-semibold mt-2">
                                            <span>Total (before delivery)</span>
                                            <span>$<%= Number(baseTotal || 0).toFixed(2) %></span>
                                          </div>
                                </div>

                                <div class="mt-4">
                                  <h6 class="text-uppercase text-muted small mb-2">Discounts</h6>
                                  <% if (appliedCoupon) { %>
                                    <div class="d-flex justify-content-between align-items-center">
                                      <span class="text-success">Coupon applied: <strong><%= appliedCoupon.code %></strong></span>
                                      <span class="badge bg-success-subtle text-success">Saved $<%= Number(appliedCoupon.discountAmount).toFixed(2) %></span>
                                    </div>
                                    <% } else { %>
                                      <p class="text-muted mb-0">No coupon applied.</p>
                                      <% } %>
                                        <% if (bundleDiscount && Number(bundleDiscount) > 0) { %>
                                          <div class="mt-2">
                                            <span class="bundle-discount">Bundle discount: extra 10% off</span>
                                          </div>
                                          <% } %>
                                </div>
                              </div>
                            </div>

                          </div>

                          <div class="col-12 col-lg-5">
                            <form action="/checkout" method="POST" class="card checkout-panel">
                              <div class="card-body">
                                <h4 class="mb-3">Delivery method</h4>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="deliveryMethod"
                                      id="checkout-pickup" value="pickup" checked>
                                    <label class="form-check-label" for="checkout-pickup">Store pickup</label>
                                  </div>
                                  <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="deliveryMethod"
                                      id="checkout-delivery" value="delivery">
                                    <label class="form-check-label" for="checkout-delivery">Island-wide delivery</label>
                                  </div>
                                </div>

                                <div class="mb-3 d-none" id="checkout-delivery-address">
                                  <label for="deliveryAddress" class="form-label">Delivery address</label>
                                  <textarea class="form-control" id="deliveryAddress" name="deliveryAddress" rows="2"
                                    placeholder="Enter delivery address"><%= user && user.address ? user.address : '' %></textarea>
                                  <small class="text-muted">Required when delivery is selected.</small>
                                </div>

                                <div class="mb-3">
                                  <label for="orderNotes" class="form-label">Order notes / Gift message (optional)</label>
                                  <textarea class="form-control" id="orderNotes" name="orderNotes" rows="3" maxlength="200"
                                    placeholder="Add delivery notes or a short gift message (max 200 characters)."></textarea>
                                  <small class="text-muted">Optional. 200 characters max.</small>
                                </div>

                                <div class="alert <%= user && user.free_delivery ? 'alert-success' : 'alert-info' %> py-2">
                                  <% if (user && user.free_delivery) { %>
                                    <strong>Free delivery unlocked.</strong> Delivery fee waived for your account.
                                    <% } else { %>
                                      Delivery adds $<%= Number(deliveryFee || 0).toFixed(2) %> when selected.
                                      <% } %>
                                </div>

                                <div class="mb-4">
                                  <h4 class="mb-3">Payment method</h4>
                                  <div class="d-grid gap-2">
                                    <% (paymentMethods || []).forEach(function(method) { %>
                                      <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod"
                                          id="payment-<%= method.value %>" value="<%= method.value %>"
                                          <%= (selectedPayment || 'card') === method.value ? 'checked' : '' %> required>
                                        <label class="form-check-label" for="payment-<%= method.value %>">
                                          <%= method.label %>
                                        </label>
                                      </div>
                                      <% }); %>
                                  </div>
                                  <small class="text-muted">PayPal and NETS QR use sandbox/test credentials.</small>
                                </div>

                                <div class="mb-3">
                                  <div class="d-flex justify-content-between">
                                    <span class="text-muted">Estimated total</span>
                                    <span class="fw-semibold" id="checkout-total"
                                      data-base-total="<%= Number(baseTotal || 0).toFixed(2) %>"
                                      data-delivery-fee="<%= Number(deliveryFee || 0).toFixed(2) %>">
                                      $<%= Number(baseTotal || 0).toFixed(2) %>
                                    </span>
                                  </div>
                                </div>

                                <div id="payment-notice" class="alert alert-info d-none mb-3"></div>
                                <button type="submit" class="btn btn-success w-100" id="checkout-submit">Place order / Pay now</button>
                                <div id="paypal-actions" class="d-none mt-2 d-grid">
                                  <button type="button" class="btn btn-primary" id="paypal-button">Pay with PayPal</button>
                                </div>
                                <div id="nets-actions" class="d-none mt-2 d-grid">
                                  <button type="button" class="btn btn-primary" id="nets-button">Generate NETS QR</button>
                                </div>
                              </div>
                            </form>

                            <div class="impact-summary mt-4">
                              <h5 class="mb-3">Estimated Impact of This Order</h5>
                              <div class="d-flex flex-column gap-2">
                                <div>üíß Water saved: <strong><%= impactSummary.waterSavedLitres %></strong> L</div>
                                <div>‚ôªÔ∏è Textile waste reduced: <strong><%= Number(impactSummary.textileWasteReducedKg || 0).toFixed(1) %></strong> kg</div>
                                <div>üåç CO‚ÇÇ emissions reduced: <strong><%= Number(impactSummary.carbonReducedKg || 0).toFixed(1) %></strong> kg</div>
                              </div>
                              <small class="text-muted d-block mt-2">Estimated using industry benchmark averages.</small>
                            </div>
                          </div>
                        </div>
                        <% } %>
  </div>
</main>

<div class="modal fade" id="netsQrModal" tabindex="-1" aria-labelledby="netsQrLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="netsQrLabel">NETS QR Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <img id="nets-qr-image" src="" alt="NETS QR Code" class="img-fluid rounded" style="max-width: 240px;">
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Amount</span>
          <span class="fw-semibold" id="nets-amount">SGD 0.00</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Reference</span>
          <span id="nets-ref">-</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Expiry</span>
          <span id="nets-expiry">-</span>
        </div>
        <div class="alert alert-info py-2 mb-0" id="nets-status">Waiting for payment...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="nets-refresh">Refresh status</button>
        <button type="button" class="btn btn-success" id="nets-paid">I have paid</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var addressGroup = document.getElementById('checkout-delivery-address');
    var notesInput = document.getElementById('orderNotes');
    var totalEl = document.getElementById('checkout-total');
    var radios = document.querySelectorAll('input[name="deliveryMethod"]');
    var paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    var paypalActions = document.getElementById('paypal-actions');
    var netsActions = document.getElementById('nets-actions');
    var submitBtn = document.getElementById('checkout-submit');
    var paypalButton = document.getElementById('paypal-button');
    var netsButton = document.getElementById('nets-button');
    var notice = document.getElementById('payment-notice');
    var checkoutForm = document.querySelector('form[action="/checkout"]');
    var netsModalEl = document.getElementById('netsQrModal');
    var netsModal = netsModalEl ? new bootstrap.Modal(netsModalEl) : null;
    var netsQrImage = document.getElementById('nets-qr-image');
    var netsAmount = document.getElementById('nets-amount');
    var netsRef = document.getElementById('nets-ref');
    var netsExpiry = document.getElementById('nets-expiry');
    var netsStatus = document.getElementById('nets-status');
    var netsRefresh = document.getElementById('nets-refresh');
    var netsPaid = document.getElementById('nets-paid');
    var netsRefValue = null;
    var netsPoller = null;

    if (!addressGroup || !totalEl) {
      return;
    }

    var baseTotal = Number(totalEl.dataset.baseTotal || 0);
    var deliveryFee = Number(totalEl.dataset.deliveryFee || 0);

    var toggle = function () {
      var selected = document.querySelector('input[name="deliveryMethod"]:checked');
      var isDelivery = selected && selected.value === 'delivery';
      addressGroup.classList.toggle('d-none', !isDelivery);
      var nextTotal = isDelivery ? baseTotal + deliveryFee : baseTotal;
      totalEl.textContent = '$' + nextTotal.toFixed(2);
    };

    radios.forEach(function (radio) {
      radio.addEventListener('change', toggle);
    });

    toggle();

    var showNotice = function (message, type) {
      if (!notice) return;
      notice.textContent = message;
      notice.className = 'alert alert-' + (type || 'info');
      notice.classList.remove('d-none');
    };

    var clearNotice = function () {
      if (!notice) return;
      notice.classList.add('d-none');
    };

    var currentPayment = function () {
      var selected = document.querySelector('input[name="paymentMethod"]:checked');
      return selected ? selected.value : '';
    };

    var updatePaymentActions = function () {
      var payment = currentPayment();
      if (submitBtn) {
        submitBtn.classList.toggle('d-none', payment === 'paypal' || payment === 'nets_qr');
      }
      if (paypalActions) {
        paypalActions.classList.toggle('d-none', payment !== 'paypal');
      }
      if (netsActions) {
        netsActions.classList.toggle('d-none', payment !== 'nets_qr');
      }
      clearNotice();
    };

    if (checkoutForm) {
      checkoutForm.addEventListener('submit', function (event) {
        var payment = currentPayment();
        if (payment === 'paypal' || payment === 'nets_qr') {
          event.preventDefault();
          showNotice('Please use the PayPal or NETS QR button to complete payment.', 'warning');
        }
      });
    }

    if (paymentRadios && paymentRadios.length) {
      paymentRadios.forEach(function (radio) {
        radio.addEventListener('change', updatePaymentActions);
      });
      updatePaymentActions();
    }

    var buildDeliveryPayload = function () {
      var deliverySelected = document.querySelector('input[name="deliveryMethod"]:checked');
      var method = deliverySelected ? deliverySelected.value : 'pickup';
      var addressInput = document.getElementById('deliveryAddress');
      var address = addressInput ? addressInput.value.trim() : '';
      var notes = notesInput ? notesInput.value.trim() : '';

      if (method === 'delivery' && !address) {
        showNotice('Please enter a delivery address.', 'danger');
        return null;
      }

      if (notes && notes.length > 200) {
        showNotice('Order notes must be 200 characters or fewer.', 'danger');
        return null;
      }

      return {
        deliveryMethod: method,
        deliveryAddress: address,
        orderNotes: notes
      };
    };

    if (paypalButton) {
      paypalButton.addEventListener('click', function () {
        var payload = buildDeliveryPayload();
        if (!payload) return;

        showNotice('Redirecting to PayPal...', 'info');
        paypalButton.disabled = true;

        fetch('/payments/paypal/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (data && data.approvalUrl) {
              window.location.href = data.approvalUrl;
              return;
            }
            paypalButton.disabled = false;
            showNotice(data && data.message ? data.message : 'Unable to start PayPal checkout.', 'danger');
          })
          .catch(function () {
            paypalButton.disabled = false;
            showNotice('Unable to start PayPal checkout.', 'danger');
          });
      });
    }

    var updateNetsStatus = function (status) {
      if (!netsStatus) return;
      if (status === 'paid') {
        netsStatus.className = 'alert alert-success py-2 mb-0';
        netsStatus.textContent = 'Payment received.';
      } else if (status === 'expired') {
        netsStatus.className = 'alert alert-danger py-2 mb-0';
        netsStatus.textContent = 'QR expired. Please generate a new code.';
      } else if (status === 'failed') {
        netsStatus.className = 'alert alert-danger py-2 mb-0';
        netsStatus.textContent = 'Payment failed. Please try again.';
      } else {
        netsStatus.className = 'alert alert-info py-2 mb-0';
        netsStatus.textContent = 'Waiting for payment...';
      }
    };

    var pollNetsStatus = function () {
      if (!netsRefValue) return;
      fetch('/payments/netsqr/status?ref=' + encodeURIComponent(netsRefValue))
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (!data || !data.status) return;
          updateNetsStatus(data.status);
          if (data.status === 'expired' || data.status === 'failed') {
            if (netsPoller) {
              clearInterval(netsPoller);
            }
          }
        });
    };

    if (netsButton) {
      netsButton.addEventListener('click', function () {
        var payload = buildDeliveryPayload();
        if (!payload) return;

        netsButton.disabled = true;
        showNotice('Generating NETS QR...', 'info');

        fetch('/payments/netsqr/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            netsButton.disabled = false;
            var qrSrc = '';
            if (data && data.qrImageDataUrl) {
              qrSrc = data.qrImageDataUrl;
            } else if (data && data.qrImageBase64) {
              qrSrc = data.qrImageBase64.startsWith('data:image')
                ? data.qrImageBase64
                : ('data:image/png;base64,' + data.qrImageBase64);
            }

            if (!data || (!qrSrc && !data.qrData)) {
              showNotice(data && data.message ? data.message : 'Unable to generate NETS QR.', 'danger');
              return;
            }

            netsRefValue = data.reference;
            if (data && data.qrImageBase64) {
              console.log('NETS QR base64 length:', data.qrImageBase64.length);
            }
            if (netsQrImage && qrSrc) netsQrImage.src = qrSrc;
            if (netsAmount) netsAmount.textContent = (data.currency || 'SGD') + ' ' + Number(data.amount || 0).toFixed(2);
            if (netsRef) netsRef.textContent = data.reference || '-';
            if (netsExpiry) netsExpiry.textContent = data.expiresAt ? new Date(data.expiresAt).toLocaleTimeString() : '-';
            updateNetsStatus('pending');

            if (netsModal) {
              netsModal.show();
            }

            if (netsPoller) {
              clearInterval(netsPoller);
            }
            netsPoller = setInterval(pollNetsStatus, 4000);
          })
          .catch(function () {
            netsButton.disabled = false;
            showNotice('Unable to generate NETS QR.', 'danger');
          });
      });
    }

    if (netsModalEl) {
      netsModalEl.addEventListener('hidden.bs.modal', function () {
        if (netsPoller) {
          clearInterval(netsPoller);
          netsPoller = null;
        }
      });
    }

    if (netsRefresh) {
      netsRefresh.addEventListener('click', function () {
        pollNetsStatus();
      });
    }

    if (netsPaid) {
      netsPaid.addEventListener('click', function () {
        if (!netsRefValue) return;
        netsPaid.disabled = true;
        fetch('/payments/netsqr/finalize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ref: netsRefValue })
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            netsPaid.disabled = false;
            if (data && data.success) {
              updateNetsStatus('paid');
              if (netsModal) {
                netsModal.hide();
              }
              window.location.href = data.redirect || '/orders/history';
              return;
            }
            updateNetsStatus('failed');
          })
          .catch(function () {
            netsPaid.disabled = false;
            updateNetsStatus('failed');
          });
      });
    }

    var params = new URLSearchParams(window.location.search);
    if (params.get('paypal') === 'cancel') {
      showNotice('PayPal payment was cancelled. Please try again.', 'warning');
    }

    if (params.get('paypal') === '1' && params.get('token')) {
      showNotice('Finalizing PayPal payment...', 'info');
      fetch('/payments/paypal/capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId: params.get('token') })
      })
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (data && data.success) {
            window.location.href = data.redirect || '/orders/history';
            return;
          }
          showNotice(data && data.message ? data.message : 'Unable to capture PayPal payment.', 'danger');
        })
        .catch(function () {
          showNotice('Unable to capture PayPal payment.', 'danger');
        });
    }
  });
</script>

<%- include('partials/footer') %>
