<%- include('partials/header', { title: 'Request Refund | Shirt Shop' }) %>
<%- include('partials/navbar', { user: typeof user !== 'undefined' ? user : null }) %>

<main class="page-section">
  <div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <p class="mb-1 text-muted">Order #<%= order.id %></p>
        <h2 class="mb-0">Request a refund</h2>
      </div>
      <a href="/orders/history" class="btn btn-outline-secondary">Back to orders</a>
    </div>

    <% if (messages && messages.length) { %>
      <% messages.forEach(function(message) { %>
        <div class="alert alert-success"><%= message %></div>
      <% }); %>
    <% } %>

    <% if (errors && errors.length) { %>
      <% errors.forEach(function(error) { %>
        <div class="alert alert-danger"><%= error %></div>
      <% }); %>
    <% } %>

    <% const paymentLabel = (method) => {
      const value = (method || '').toString().toLowerCase();
      if (value === 'paypal') return 'PayPal';
      if (value === 'stripe') return 'Stripe';
      if (value === 'netsqr') return 'NETS QR';
      return method ? method.toUpperCase() : 'Unknown';
    }; %>
    <% const deliveryFee = Number(order.shipping_amount || order.delivery_fee || 0); %>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Refund details</h5>
            <p class="text-muted mb-3">Let us know why you want a refund. Our team will review it.</p>
            <div class="alert alert-light border small mb-3">
              Refund eligibility: The maximum refundable amount is shown below. Refunds are usually approved for damaged
              or incorrect items. Please provide a clear reason.
            </div>
            <% if (eligibility && !eligibility.eligible) { %>
              <div class="alert alert-warning">
                This order is not eligible for a refund.
                <% if (!eligibility.paid) { %>
                  Payment has not been completed.
                <% } else if (!eligibility.statusEligible) { %>
                  Only completed orders can be refunded.
                <% } else if (!eligibility.withinWindow) { %>
                  Refunds must be requested within <%= refundWindowDays %> days.
                <% } %>
              </div>
            <% } %>
            <form action="/refunds/request/<%= order.id %>" method="POST">
              <div class="mb-3">
                <label class="form-label">Select items to refund</label>
                <% if (!orderItems || !orderItems.length) { %>
                  <div class="text-muted small">No items found for this order.</div>
                <% } else { %>
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>Item</th>
                          <th class="text-center">Qty bought</th>
                          <th class="text-center">Refundable</th>
                          <th class="text-end">Unit price</th>
                          <th class="text-end">Refund qty</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% orderItems.forEach(function(item) { %>
                          <tr>
                            <td><%= item.productName %></td>
                            <td class="text-center"><%= item.quantity %></td>
                            <td class="text-center"><%= item.refundableQty %></td>
                            <td class="text-end">$<%= Number(item.refundableUnitPrice || item.price).toFixed(2) %></td>
                            <td class="text-end">
                              <input
                                type="number"
                                class="form-control form-control-sm refund-item-input"
                                name="items[<%= item.id %>]"
                                min="0"
                                max="<%= item.refundableQty %>"
                                step="1"
                                value="0"
                                data-unit-price="<%= Number(item.refundableUnitPrice || item.price).toFixed(2) %>"
                                <%= item.refundableQty === 0 ? 'disabled' : '' %>>
                            </td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                <% } %>
              </div>
              <div class="mb-3">
                <label class="form-label">Estimated refund</label>
                <div class="form-control-plaintext fw-semibold" id="refund-estimate">$0.00</div>
                <small class="text-muted">Final refund amount is calculated on the server after discount proration.</small>
                <% if (deliveryFee > 0) { %>
                  <div class="small text-muted">Delivery fee is refunded only for full-order refunds.</div>
                <% } %>
              </div>
              <div class="mb-3">
                <label class="form-label">Reason</label>
                <select name="reason" class="form-select" required>
                  <option value="" selected disabled>Select a reason</option>
                  <option value="wrong_item">Wrong item received</option>
                  <option value="damaged">Item damaged</option>
                  <option value="not_received">Item not received</option>
                  <option value="changed_mind">Changed mind</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="refund-comment" class="form-label">Additional details (optional)</label>
                <textarea
                  id="refund-comment"
                  name="comment"
                  rows="3"
                  class="form-control"
                  placeholder="Share any extra details to help us review your request."></textarea>
              </div>
              <button type="submit" class="btn btn-primary" <%= eligibility && !eligibility.eligible ? 'disabled' : '' %>>Submit request</button>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Order summary</h5>
            <ul class="list-unstyled mb-0">
              <li class="d-flex justify-content-between">
                <span>Total paid</span>
                <span>$<%= Number(order.total_amount || order.total || 0).toFixed(2) %></span>
              </li>
              <% if (deliveryFee > 0) { %>
                <li class="d-flex justify-content-between">
                  <span>Delivery fee</span>
                  <span>$<%= deliveryFee.toFixed(2) %></span>
                </li>
              <% } %>
              <li class="d-flex justify-content-between">
                <span>Refunded to date</span>
                <span>$<%= Number(order.refunded_amount || 0).toFixed(2) %></span>
              </li>
              <li class="d-flex justify-content-between fw-semibold">
                <span>Remaining</span>
                <span>$<%= remaining.toFixed(2) %></span>
              </li>
              <li class="d-flex justify-content-between mt-2">
                <span>Payment method</span>
                <span><%= paymentLabel(order.payment_method) %></span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  (function () {
    var estimateEl = document.getElementById('refund-estimate');
    var itemInputs = Array.prototype.slice.call(document.querySelectorAll('.refund-item-input'));
    if (!estimateEl) return;

    var updateEstimate = function () {
      if (!itemInputs.length) {
        estimateEl.textContent = '$0.00';
        return;
      }
      var sum = 0;
      itemInputs.forEach(function (input) {
        var qty = parseFloat(input.value || '0');
        var price = parseFloat(input.dataset.unitPrice || '0');
        if (Number.isFinite(qty) && Number.isFinite(price)) {
          sum += qty * price;
        }
      });
      estimateEl.textContent = '$' + sum.toFixed(2);
    };

    itemInputs.forEach(function (input) {
      input.addEventListener('input', updateEstimate);
    });
    updateEstimate();
  })();
</script>

<%- include('partials/footer') %>
