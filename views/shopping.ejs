<%#
I declare that this code was written by me.
I will not copy or allow others to copy my code.
I understand that copying code is considered as plagiarism.

Student Name: Wong De En Amos
Student ID: 24042274
Class: C372-002
Date created: 06/02/2026
%>

<%- include('partials/header', { title: 'Shirt Shop | Shopping' }) %>
  <%- include('partials/navbar', { user: user }) %>
    <% const freshArrivals=products ? products.slice(0, Math.min(products.length, 3)) : []; %>
      <% const hasFilters=activeCategory || activeBrand || searchQuery || activeSort; %>
        <% const isAdmin=user && user.role==='admin' ; %>
          <% const totalProducts=isAdmin && products ? products.length : 0; %>
            <% const totalInStock=isAdmin && products ? products.reduce((sum, p)=> sum + p.quantity, 0) : 0; %>
            <% if (freshArrivals.length > 1) { %>
              <div class="mb-4">
                <span class="text-uppercase small text-muted">Fresh picks for you</span>
              </div>
            <% } %>

            <main class="page-section pt-4 pb-5">
              <div class="container">
                <div class="shop-hero mb-4">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                    <div>
                      <p class="text-uppercase text-muted small mb-2">Welcome back, <%= user.username %>
                      </p>
                      <h1 class="mb-2">Shop the latest fits</h1>
                      <p class="text-muted mb-0">Browse styles, filter by brand, and check out in a few clicks.</p>
                    </div>
                    <div class="d-flex flex-column align-items-start align-items-lg-end gap-2">
                      <span class="authenticity-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                          stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M12 3l7 3v5c0 5-3.5 8.5-7 10-3.5-1.5-7-5-7-10V6l7-3z" />
                          <path d="M9 12l2 2 4-4" />
                        </svg>
                        100% Authenticity Guaranteed
                      </span>
                      <div class="d-flex flex-wrap gap-2">
                        <a href="/cart" class="btn btn-primary">Open your cart</a>
                        <% if (freshArrivals.length) { %>
                          <a href="/product/<%= freshArrivals[0].id %>" class="btn btn-outline-secondary">View
                            highlight</a>
                          <% } %>
                      </div>
                    </div>
                  </div>
                  <% if (isAdmin) { %>
                    <div class="d-flex flex-wrap gap-3 mt-3">
                      <div class="stat-pill">Products live: <strong>
                          <%= totalProducts %>
                        </strong></div>
                      <div class="stat-pill">Units available: <strong>
                          <%= totalInStock %>
                        </strong></div>
                    </div>
                    <% } %>
                </div>

                <div class="filter-bar mb-4">
                  <form class="row gy-3 align-items-end" action="/shopping" method="GET">
                    <div class="col-12 col-lg-4">
                      <label for="search-input" class="form-label">Search</label>
                      <input type="text" id="search-input" name="q" class="form-control"
                        placeholder="Search by name or description" value="<%= searchQuery || '' %>">
                    </div>
                    <div class="col-6 col-lg-2">
                      <label for="brand-filter" class="form-label">Brand</label>
                      <select id="brand-filter" name="brand" class="form-select">
                        <option value="">All brands</option>
                        <% (brands || []).forEach(function(brand) { %>
                          <option value="<%= brand %>" <%=activeBrand===brand ? 'selected' : '' %>><%= brand %>
                          </option>
                          <% }); %>
                      </select>
                    </div>
                    <div class="col-6 col-lg-2">
                      <label for="category-filter" class="form-label">Category</label>
                      <select id="category-filter" name="category" class="form-select">
                        <option value="">All categories</option>
                        <% (categories || []).forEach(function(cat) { %>
                          <option value="<%= cat %>" <%=activeCategory===cat ? 'selected' : '' %>><%= cat %>
                          </option>
                          <% }); %>
                      </select>
                    </div>
                    <div class="col-6 col-lg-2">
                      <label for="sort-filter" class="form-label">Sort</label>
                      <select id="sort-filter" name="sort" class="form-select">
                        <option value="">Recommended</option>
                        <option value="newest" <%=activeSort==='newest' ? 'selected' : '' %>>Newest</option>
                        <option value="price_asc" <%=activeSort==='price_asc' ? 'selected' : '' %>>Price low-high
                        </option>
                        <option value="price_desc" <%=activeSort==='price_desc' ? 'selected' : '' %>>Price high-low
                        </option>
                      </select>
                    </div>
                    <div class="col-6 col-lg-2 d-grid">
                      <button type="submit" class="btn btn-primary">Apply filters</button>
                    </div>
                    <% if (hasFilters) { %>
                      <div class="col-12">
                        <a href="/shopping" class="btn btn-link text-decoration-none">Clear all filters</a>
                      </div>
                      <% } %>
                  </form>
                </div>

                <% if (messages && messages.length) { %>
                  <% messages.forEach(function(message) { %>
                    <div class="alert alert-success">
                      <%= message %>
                    </div>
                    <% }); %>
                      <% } %>

                        <% if (errors && errors.length) { %>
                          <% errors.forEach(function(error) { %>
                            <div class="alert alert-danger">
                              <%= error %>
                            </div>
                            <% }); %>
                              <% } %>

                                <% if (bestSellers && bestSellers.length) { %>
                                  <div class="mb-5">
                                    <span class="text-uppercase small text-muted">Best sellers</span>
                                    <h3 class="mt-2">Community favourites</h3>
                                    <div class="best-seller-row mt-3">
                                      <% bestSellers.forEach(function(item) { %>
                                        <div class="card border-0 shadow-sm">
                                          <% if (item.image) { %>
                                            <img src="/images/<%= item.image %>" class="card-img-top"
                                              alt="<%= item.productName %>">
                                            <% } else { %>
                                              <div
                                                class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                                style="height: 160px;">
                                                <span class="text-muted">Image coming soon</span>
                                              </div>
                                              <% } %>
                                                <div class="card-body">
                                                  <div class="d-flex justify-content-between align-items-start">
                                                    <h6 class="card-title mb-0">
                                                      <a class="text-decoration-none text-dark"
                                                        href="/product/<%= item.id %>">
                                                        <%= item.productName %>
                                                      </a>
                                                    </h6>
                                                  </div>
                                                  <p class="text-muted small mb-2">Sold <%= item.totalSold %> times</p>
                                                  <% if (item.hasDiscount) { %>
                                                    <div class="d-flex flex-column mb-2">
                                                      <span class="text-muted text-decoration-line-through small">$<%=
                                                          Number(item.price).toFixed(2) %></span>
                                                      <span class="fw-semibold text-success">$<%=
                                                          Number(item.effectivePrice).toFixed(2) %></span>
                                                    </div>
                                                    <% } else { %>
                                                      <div class="fw-semibold mb-2">$<%= Number(item.price).toFixed(2)
                                                          %>
                                                      </div>
                                                      <% } %>
                                                        <a href="/product/<%= item.id %>"
                                                          class="btn btn-outline-primary btn-sm w-100">View details</a>
                                                </div>
                                        </div>
                                        <% }); %>
                                    </div>
                                  </div>
                                  <% } %>

                                        <% if (bundles && bundles.length) { %>
                                          <div class="mb-5">
                                            <span class="text-uppercase small text-muted">Style bundles</span>
                                            <h3 class="mt-2">Style match & save</h3>
                                            <div class="row g-3 mt-3">
                                              <% bundles.forEach(function(bundle) { %>
                                                <div class="col-12 col-lg-4">
                                                  <div class="bundle-card p-3 h-100">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                      <div>
                                                        <h5 class="mb-1">
                                                          <%= bundle.title %>
                                                        </h5>
                                                        <span class="bundle-discount">Bundle discount: extra 10% off</span>
                                                      </div>
                                                    </div>
                                                    <div class="bundle-items mt-3">
                                                      <% bundle.items.forEach(function(item) { %>
                                                        <div class="bundle-item">
                                                          <% if (item.image) { %>
                                                            <img src="/images/<%= item.image %>"
                                                              alt="<%= item.productName %>">
                                                            <% } else { %>
                                                              <div
                                                                class="bg-light rounded d-flex align-items-center justify-content-center"
                                                                style="height:90px;">
                                                                <span class="text-muted small">No image</span>
                                                              </div>
                                                              <% } %>
                                                                <div class="fw-semibold small">
                                                                  <%= item.productName %>
                                                                </div>
                                                                <div class="text-muted small">
                                                                  <%= item.brand || 'Independent' %>
                                                                </div>
                                                        </div>
                                                        <% }); %>
                                                    </div>
                                                    <form action="/bundle/add" method="POST" class="mt-3">
                                                      <% bundle.items.forEach(function(item) { %>
                                                        <input type="hidden" name="productIds" value="<%= item.id %>">
                                                        <% }); %>
                                                          <button type="submit" class="btn btn-primary w-100">Add bundle to
                                                            cart</button>
                                                    </form>
                                                  </div>
                                                </div>
                                                <% }); %>
                                            </div>
                                          </div>
                                          <% } %>

                                        <% if (freshArrivals.length > 1) { %>
                                          <div class="mb-4">
                                            <span class="text-uppercase small text-muted">New arrivals for you</span>
                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                              <% freshArrivals.forEach(function(item) { %>
                                                <a href="/product/<%= item.id %>"
                                                  class="badge bg-light text-dark border rounded-pill px-3 py-2">
                                                  <%= item.productName %>
                                                </a>
                                                <% }); %>
                                            </div>
                                          </div>
                                          <% } %>

                                            <div class="row g-4 product-grid">
                                              <% if (products && products.length) { %>
                                                <% products.forEach(function(product) { %>
                                                  <div class="col-12 col-sm-6 col-lg-4 col-xxl-3">
                                                    <div class="card h-100 product-card">
                                                      <div class="position-relative">
                                                        <% if (product.image) { %>
                                                          <img src="/images/<%= product.image %>"
                                                            class="card-img-top product-card-image"
                                                            alt="<%= product.productName %>">
                                                          <% } else { %>
                                                            <div
                                                              class="card-img-top product-card-image bg-light d-flex align-items-center justify-content-center">
                                                              <span class="text-muted">Image coming soon</span>
                                                            </div>
                                                            <% } %>
                                                              <% if (product.hasDiscount) { %>
                                                                <span
                                                                  class="position-absolute top-0 start-0 m-3 discount-badge">-
                                                                  <%= Number(product.discountPercentage).toFixed(0) %>
                                                                    %</span>
                                                                <% } %>
                                                                  <span
                                                                    class="position-absolute top-0 end-0 m-3 badge bg-dark-subtle text-dark">
                                                                    Stock: <%= product.quantity %>
                                                                  </span>
                                                      </div>
                                                      <div class="card-body d-flex flex-column">
                                                        <span class="product-brand">
                                                          <%= product.brand || 'Independent' %>
                                                        </span>
                                                        <h5 class="card-title mb-1">
                                                          <a href="/product/<%= product.id %>"
                                                            class="text-decoration-none text-dark stretched-link">
                                                            <%= product.productName %>
                                                          </a>
                                                        </h5>
                                                        <span class="badge bg-light text-dark align-self-start mb-2">
                                                          <%= product.category || 'General' %>
                                                        </span>
                                                        <div
                                                          class="d-flex align-items-center justify-content-between mb-2">
                                                          <% if (product.hasDiscount) { %>
                                                            <div class="text-muted text-decoration-line-through small">$
                                                              <%= Number(product.price).toFixed(2) %>
                                                            </div>
                                                            <div class="fw-semibold text-success">$<%=
                                                                Number(product.effectivePrice).toFixed(2) %>
                                                            </div>
                                                            <% } else { %>
                                                              <span class="fw-semibold text-primary">$<%=
                                                                  Number(product.price).toFixed(2) %></span>
                                                              <% } %>
                                                        </div>
                                                        <% if (product.quantity> 0) { %>
                                                          <form action="/add-to-cart/<%= product.id %>" method="POST"
                                                            class="mt-auto">
                                                            <% if (product.defaultVariantId) { %>
                                                              <input type="hidden" name="variantId"
                                                                value="<%= product.defaultVariantId %>">
                                                              <% } %>
                                                                <label for="quantity-<%= product.id %>"
                                                                  class="form-label small text-uppercase fw-semibold text-muted">Quick
                                                                  add</label>
                                                                <div class="d-grid gap-2 d-sm-flex">
                                                                  <select class="form-select"
                                                                    id="quantity-<%= product.id %>" name="quantity">
                                                                    <% const maxQty=Math.min(product.quantity, 10); %>
                                                                      <% for (let q=1; q <=maxQty; q++) { %>
                                                                        <option value="<%= q %>">
                                                                          <%= q %>
                                                                        </option>
                                                                        <% } %>
                                                                  </select>
                                                                  <button type="submit"
                                                                    class="btn btn-primary">Add</button>
                                                                </div>
                                                          </form>
                                                          <% } else { %>
                                                            <div class="alert alert-warning mt-auto mb-0" role="alert">
                                                              Out of stock - we'll restock soon!
                                                            </div>
                                                            <% } %>
                                                      </div>
                                                    </div>
                                                  </div>
                                                  <% }); %>
                                                    <% } else { %>
                                                      <div class="col-12">
                                                        <div class="empty-state">
                                                          <h3>We're restocking the shelves</h3>
                                                          <p class="text-muted mb-0">Check back shortly for new arrivals
                                                            tailored
                                                            to you.</p>
                                                        </div>
                                                      </div>
                                                      <% } %>
                                            </div>
              </div>
            </main>

            <%- include('partials/footer') %>
